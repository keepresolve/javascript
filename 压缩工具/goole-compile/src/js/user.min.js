$(function(){var t,e,i,s,n,a,o,r,c,m=/Android|webOS|iPhone|iPad|BlackBerry/i.test(navigator.userAgent)?0:1;1==m&&(self!=top?($(".minimize").show(),$(".toggle").show()):"model"==location.href.split("?")[1].split("=")[1]&&window.localStorage.removeItem("isopenmodelwindow"));var l="",d=["/::)","/::~","/::B","/::|","/:8-)","/::<","/::$","/::X","/::Z","/::'(","/::-|","/::@","/::P","/::D","/::O","/::(","/::+","/:--b","/::Q","/::T","/:,@P","/:,@-D","/::d","/:,@o","/::g","/:|-)","/::!","/::L","/::>","/::,@","/:,@f","/::-S","/:?","/:,@x","/:,@@","/::8","/:,@!","/:!!!","/:xx","/:bye","/:wipe","/:dig","/:handclap","/:&-(","/:B-)","/:<@","/:@>","/::-O","/:>-|","/:P-(","/::'|","/:X-)","/::*","/:@x","/:8*","/:pd","/:<W>","/:beer","/:basketb","/:oo","/:coffee","/:eat","/:pig","/:rose","/:fade","/:showlove","/:heart","/:break","/:cake","/:li","/:bome","/:kn","/:footb","/:ladybug","/:shit","/:moon","/:sun","/:gift","/:hug","/:strong","/:weak","/:share","/:v","/:@)","/:jj","/:@@","/:bad","/:lvu","/:no","/:ok","/:love","/:<L>","/:jump","/:shake","/:<O>","/:circle","/:kotow","/:turn","/:skip","/:oY","/:#-0","/:hiphot","/:kiss","/:<&","/:&>"],p={};$.ajax({type:"GET",url:l+"/epConfig/channelManage/query",data:{role:"guest",configData:"kefuIcon,cs_epname,advertisement,windowColor,advertisementPic,advertisementUrl,advertisementContent,conclusion,satisfaction,no_workingtime_alter"},cache:!1,success:function(t){if(200==t.code){if(p=t.data,window.parent.postMessage({key:"eConfig",val:p},"*"),p.cs_epname.length>15?$(".enterprise_name").html(p.cs_epname.substring(0,14)+"..."):$(".enterprise_name").html(p.cs_epname),p.kefuIcon)var e=l+p.kefuIcon;else e="img/eplogo.png";if($(".ep_logo").attr("src",e),$(".leave_word_prompting").html(p.no_workingtime_alter.web_context),"0"==m?($(".session_header,.leave_word_header,#send_message,.wap_reconnect_kefu").css("background",p.windowColor),$(".btn_enter").css({color:p.windowColor}),$("#text_div").css({caretColor:p.windowColor})):$(".session_header,.btn_enter,.leave_word_header,#send_message,.reconnect_kefu").css("background",p.windowColor),2==parseInt(p.advertisement)&&"0"!=m){if($(".session_main_right").show(),self!=top||document.body.offsetWidth<=800)var i=181;else i=251;if($(".session_main").css("width",$(".session_main").width()+i+"px"),void 0==p.advertisementUrl)var s=$('<a href="javascript:void(0)" >\t\t\t\t\t\t\t\t\t\t\t\t\t<img src="'+l+p.advertisementPic+'">\t\t\t\t\t\t\t\t\t\t\t\t</a>');else{if(p.advertisementUrl.indexOf("http://")>=0||p.advertisementUrl.indexOf("https://")>=0)var n=p.advertisementUrl;else n="http://"+p.advertisementUrl;s=$('<a target="_blank" href="'+n+'">\t\t\t\t\t\t\t\t\t\t\t<img src="'+l+p.advertisementPic+'">\t\t\t\t\t\t\t\t\t\t</a>')}var a=new Image;a.src=l+p.advertisementPic,a.onload=function(){r=this.height/(this.width/160)+35,c=this.height/(this.width/230)+35,$(".announcement_con").css("height","calc(100% - "+r+"px)")},$(".announcement_pic").append(s),$(".announcement_con").html(p.advertisementContent)}else $(".session_main_right").hide()}}});var g=window.localStorage.getItem("emickfEpid")?window.localStorage.getItem("emickfEpid"):location.href.split("?")[1].split("=")[1],u=io(l+"/"+g);u.on("connect",function(i){t=1,e=1,v()}),u.on("chat_message",function(t){$(".wait_prompting").remove(),D(Date.now());var e=t.content,i=t.time,s=t.type,n=t.nickName?t.nickName:"";2==t.role?C(1,"text","center",e):1==t.role?C(1,s,"left",T(e),i,n):0==t.role&&C(1,s,"right",T(e),i,""),_({key:"openchat"}),M({msg:T(e),name:n,icon:$(".ep_logo").attr("src"),type:s})}),u.on("close_session",function(t){$(".direct-chat-messages").attr("roomID",k()),x(0),$("#typing_text").hide();var i=Date.now();p&&p.conclusion&&0==parseInt(p.conclusion.disabled)?C(1,"","closesession",t.content,i,t.nickName):C(1,"","closesession","",i,t.nickName),"0"!=m?$(".reconnect_kefu").show():$(".wap_reconnect_kefu").show(),e=1}),u.on("typing",function(t){"1"==t.status?$("#typing_text").show():$("#typing_text").hide()}),u.on("disconnect",function(){t=0,x(0)}),u.on("reconnect",function(){t=1,x(1),location.replace(location.href)}),u.on("reconnect_failed",function(){t=0,x(0)}),$("body").on("click",".score_btn",function(){var t=$(this).attr("val"),e=$(this).attr("roomID");u.emit("score",{roomID:e,score:t},function(t){}),$(this).parents(".direct-chat-text").find(".evaluation_button_box").hide(),$(this).parents(".direct-chat-text").find(".fk_jg").show()}),$(".minimize").click(function(){_({key:"close"})}),$(".toggle").click(function(){self!=top?_({key:"toggle"}):("model"==location.href.split("?")[1].split("=")[1]&&(localStorage.sessionwindowstyle=0),window.close())}),window.onbeforeunload=function(){self==top&&("model"==location.href.split("?")[1].split("=")[1]&&"1"!=localStorage.isopenmodelwindow&&(localStorage.sessionwindowstyle=0))},$(".btn_enter").click(function(){0!=i&&(""!=$(".msg_cont").html().replace("<br>","")&&b($(".msg_cont").html().replace(/<img [^>]*dataface=["]([^"]+)[^>]*>/gi,function(t,e){return e})))}),$(".msg_cont").keydown(function(t){if(0!=i)if(13!=t.which&&13!=t.keyCode);else{if(t.cancelBubble=!0,t.preventDefault(),t.stopPropagation(),""==$(".msg_cont").html().replace("<br>",""))return;b($(this).html().replace(/<img [^>]*dataface=["]([^"]+)[^>]*>/gi,function(t,e){return e}))}});function f(){if("0"!=m){var t=$("input[name='name']").val(),e=$("input[name='phone']").val(),i=$("textarea[name='message']").val();$.form.isEmpty(t)&&$.form.isPhone(e)&&i.length>0?$("#send_message").css("opacity","1"):$("#send_message").css("opacity","0.6")}}function h(t){$("#send_message").css("opacity","0.6"),$.post(l+"/cs/guest/createNoteMessage",t,function(){}),"0"!=m?($(".post_success_box").show(),$(".post_message_main").hide(),setTimeout(function(){_({key:"close"})},2e3)):($("#send_message").attr("isclick","1"),$.tip("提交成功"),setTimeout(function(){history.go(-1)},2e3))}function _(t){window.parent.postMessage(t,"*")}function v(t){var i=k(),s=y();null!==i&&"null"!==i||(i=null),null!==s&&"null"!==s||(s=null),u.emit("user_login",{browser:navigator.userAgent,roomID:i,userID:s},function(i){e=0,w(i,t)})}function w(e,i){if(-1!=e.access)return-2==e.access?(u.access=!1,localStorage.setItem("roomID",e.roomID),localStorage.setItem("userID",e.userID),"notgethistory"!=i&&S(e.userID),void x(1)):void(0==e.access?($(".session_main").hide(),$(".leave_word_main").show(),e.userID&&localStorage.setItem("userID",e.userID),$(".leave_word_prompting").html("当前非工作时间，如需帮助请留言"),self!=top&&_({key:"isrefresh",val:1}),u.disconnect(),t=0):(x(1),localStorage.setItem("roomID",e.roomID),localStorage.setItem("userID",e.userID),u.access=!0,10==e.access?C(1,"text","access",e.msg):2==e.access?C(1,"text","leaveword",e.msg):1==e.access&&C(1,"text","leave_word",e.msg),"notgethistory"!=i&&S(e.userID)))}function x(t){i=t,0==t?($(".msg_send_mask").show(),$(".msg_cont").removeAttr("contenteditable"),$(".msg_cont").html("")):1==t&&($(".msg_send_mask").hide(),$(".msg_cont").attr("contenteditable",!0))}function b(t){var e=Date.now(),i=k();u.emit("chat_message",{content:t,type:"text",roomID:i},function(t){u.access||w(t,"notgethistory")}),D(e),C(1,"text","right",T(t),e),$(".msg_cont").html(""),"0"==m&&$("#text_div").css("bottom","14px")}function k(){return window.localStorage.getItem("roomID")}function y(){return window.localStorage.getItem("userID")}function I(t){var e=new Date(t),i=e.getFullYear();(new Date).getFullYear()===i&&(i="");var s=e.getMonth()+1,n=e.getDate();(new Date).toDateString()===e.toDateString()&&(s="",n="");var a=e.getHours(),o=e.getMinutes(),r=e.getSeconds();return""!==s&&s<10&&(s="0"+s),""!==n&&n<10&&(n="0"+n),a<10&&(a="0"+a),o<10&&(o="0"+o),r<10&&(r="0"+r),[i+i?" ":""+s,s?"-":"",n," ",a,":",o,":",r].join("")}function D(t){var e=I(t);0==$(".timestr").length?C(1,"text","timestr",e):t-(s=s||Date.now())>6e4&&C(1,"text","timestr",e);s=t}function C(t,e,i,s,n,a){switch("right"==i&&(a=""),i){case"timestr":var o=$('<div class="direct-chat-msg timestr msg_center">\t\t\t\t\t\t\t<div>\t\t\t\t\t\t\t\t<span class="">'+s+"</span>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>");break;case"center":o=$('<div class="direct-chat-msg  msg_center">\t\t\t\t\t\t\t<div>\t\t\t\t\t\t\t\t<span class="">'+s+"</span>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>");break;case"access":o=$('<div class="direct-chat-msg  access_user msg_center">\t\t\t\t\t\t\t<div>\t\t\t\t\t\t\t\t<span class="">'+s+"</span>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>");break;case"leaveword":o=$('<div class="direct-chat-msg  msg_center wait_prompting">\t\t\t\t\t\t\t<div>\t\t\t\t\t\t\t\t<span class="">前面还有 <span style="color:#FD3D39">'+s+'</span> 位在排队 ! 您可以<a class="load_message" href="javascript:void(0)">转为留言</a></span>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>');break;case"leave_word":o=$('<div class="direct-chat-msg  msg_center wait_prompting">\t\t\t\t\t\t\t<div>\t\t\t\t\t\t\t\t<span class="">当前没有客服在线，</span><span class="">你也可以 <a class="load_message" href="javascript:void(0)">转为留言</a>, 客服会在第一时间联系您</span>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>');break;case"closesession":o=$('<div class="direct-chat-msg  direct_chat_msg left msg_left" skipTime="'+n+'">\t\t\t\t\t\t\t<div class="direct-chat-info pull-left direct-chat-info-name">'+a+'</div>\t\t\t\t\t\t\t<div class="direct-chat-text">\t\t\t\t\t\t\t\t<div>'+s+'</div>\t\t\t\t\t\t\t\t<div class="fk_jg" style="display:none;">感谢您的反馈</div>\t\t\t\t\t\t\t\t<div class="evaluation_button_box">\t\t\t\t\t\t\t\t\t<span style="font-size: 12px;color: #888888;letter-spacing: -0.6px;">是否解决了您的问题：</span>\t\t\t\t\t\t\t\t\t<div class="score_btn" roomID="'+k()+'"  style="float:left" val="2">\t\t\t\t\t\t\t\t\t\t<img style="margin-left: 15px;position:relative;top:1px;" src="img/e_up.png">\t\t\t\t\t\t\t\t\t\t<span>解决</span>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t<div class="score_btn" roomID="'+k()+'" style="float:right" val="1">\t\t\t\t\t\t\t\t\t\t<img style="margin-left: 10px;position:relative;top:3px;" src="img/e_down.png">\t\t\t\t\t\t\t\t\t\t<span>未解决</span>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>');window.localStorage.removeItem("roomID"),""==s&&o.find(".evaluation_button_box").css("margin-top","0px");break;default:switch(e){case"text":o=$('<div class="direct-chat-msg  direct_chat_msg '+i+" msg_"+i+'" skipTime="'+n+'">\t\t\t\t\t\t\t<div class="direct-chat-info pull-'+i+' direct-chat-info-name">'+a+'</div>\t\t\t\t\t\t\t<div class="direct-chat-text">'+s+"</div>\t\t\t\t\t\t</div>");break;case"file":o=$('<div class="direct-chat-msg  direct_chat_msg '+i+" msg_"+i+'" skipTime="'+n+'">\t\t\t\t\t\t\t\t<div class="direct-chat-info pull-'+i+' direct-chat-info-name">'+a+'</div>\t\t\t\t\t\t\t\t<div class="direct-chat-text" dataurl="'+s+'">\t\t\t\t\t\t\t\t\t<img class="msg_file" src="img/photo1.png">\t\t\t\t\t\t\t\t\t<div class="msg_file_des">\t\t\t\t\t\t\t\t\t\t<div class="file_name">问题集合.text</div>\t\t\t\t\t\t\t\t\t\t<div class="file_size">1.3M</div>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>');break;case"image":o=$('<div class="direct-chat-msg  direct_chat_msg '+i+" msg_"+i+'" skipTime="'+n+'">\t\t\t\t\t\t\t\t<div class="direct-chat-info pull-'+i+' direct-chat-info-name">'+a+'</div>\t\t\t\t\t\t\t\t<div class="direct-chat-text"  >\t\t\t\t\t\t\t\t\t<img class="msg_img" src="'+l+s+'">\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>')}}if(1!=t)return o;$(".direct-chat-messages").append(o),$(o)[0].scrollIntoView(!0),"file"!=e&&"image"!=e||setTimeout(function(){$(o)[0].scrollIntoView(!0)},150)}function S(t){$.ajax({type:"GET",url:l+"/cs/guest/getHistoryMessage",data:{userid:t,role:"guest"},cache:!1,success:function(t){200==t.code&&function(t){var e=t.data.messages;for(var i=0;i<e.length;i++){var s=e[i].role,a=e[i].time,o=e[i].type,r=e[i].content;if("1"==s)var c="left",m=e[i].from?e[i].from.uid&&e[i].from.uid.nickName?e[i].from.uid.nickName:e[i].from.aid&&e[i].from.aid.sender_nickname?e[i].from.aid.sender_nickname:"":"系统消息";else if("0"==s)var c="right";else if("2"==s)var c="center";var d=(n=n||a)-a;if(d>6e4){var p=C(0,"text","timestr",I(a));$(".direct-chat-messages").prepend(p)}var g=C(0,o,c,T(r),a,m);if("image"==o){var u=new Image;u.src=l+r,u.onload=function(){$(".access_user")[0]?$(".access_user")[0].scrollIntoView(!0):$(".wait_prompting")[0]&&$(".wait_prompting")[0].scrollIntoView(!0)}}$(".direct-chat-messages").prepend(g),n=a}if(e.length>11){var g=C(0,"text","center",'<a class="getMoreMsg">查看更多</a>');$(".direct-chat-messages").prepend(g)}$(".direct-chat-msg").length>0&&$(".direct-chat-msg")[$(".direct-chat-msg").length-1].scrollIntoView(!0)}(t)}})}function T(t){var e=new RegExp("(/::\\)|/::~|/::B|/::\\||/:8-\\)|/::<|/::\\$|/::X|/::Z|/::'\\(|/::-\\||/::@|/::P|/::D|/::O|/::\\(|/::\\+|/:--b|/::Q|/::T|/:,@P|/:,@-D|/::d|/:,@o|/::g|/:\\|-\\)|/::!|/::L|/::>|/::,@|/:,@f|/::-S|/:\\?|/:,@x|/:,@@|/::8|/:,@!|/:!!!|/:xx|/:bye|/:wipe|/:dig|/:handclap|/:&-\\(|/:B-\\)|/:<@|/:@>|/::-O|/:>-\\||/:P-\\(|/::'\\||/:X-\\)|/::\\*|/:@x|/:8\\*|/:pd|/:<W>|/:beer|/:basketb|/:oo|/:coffee|/:eat|/:pig|/:rose|/:fade|/:showlove|/:heart|/:break|/:cake|/:li|/:bome|/:kn|/:footb|/:ladybug|/:shit|/:moon|/:sun|/:gift|/:hug|/:strong|/:weak|/:share|/:v|/:@\\)|/:jj|/:@@|/:bad|/:lvu|/:no|/:ok|/:love|/:<L>|/:jump|/:shake|/:<O>|/:circle|/:kotow|/:turn|/:skip|/:oY|/:#-0|/:hiphot|/:kiss|/:<&|/:&>)","g");return t.replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(e,function(t,e){var i=d.indexOf(t)+1;return i<10&&(i="0"+i),'<img src="plugins/emoji/face/'+i+'.gif">'})}$(".msg_cont").focus(function(){navigator.userAgent.indexOf("iphone")>-1&&setTimeout(function(){window.scrollTo(0,$("body").height()),$(".direct-chat-messages").scrollTop($(".direct-chat-messages").get(0).scrollHeight-$(".direct-chat-messages").height())},500),$(this).removeClass("placeholder"),u.emit("typing",{status:1,roomID:k()})}),$(".msg_cont").blur(function(){""==$(this).html().replace("<br>","")?($(this).html(""),$(this).addClass("placeholder")):$(this).removeClass("placeholder"),u.emit("typing",{status:0,roomID:k()})}),$(".msg_cont").mouseleave(function(){var t=window.getSelection?window.getSelection():document.selection;t.focusNode&&t.focusNode.parentNode&&"text_div"===t.focusNode.parentNode.id&&(a=(o=t).createRange?o.createRange():o.getRangeAt(0))}),$(".web_face").click(function(t){if(t.stopPropagation(),"0"!=m?document.getElementById("text_div").focus():document.getElementById("text_div").blur(),0==$(this).attr("isshow")){"0"==m&&$(".session_main").css("top","-257px");for(var e="0"==m?30:104,i=1;i<e;i++){var s=i-1;i<10&&(i="0"+i);var n=$('<li class="face pull_left" >\t\t\t\t\t\t<img dataface="'+d[s]+'" src="plugins/emoji/face/'+i+'.gif">\t\t\t\t\t</li>');$(".facelist").append(n)}$(".facelist").show(),$(this).attr("isshow","1")}else 1==$(this).attr("isshow")&&("0"==m&&$(".session_main").css("top","0px"),$(".facelist").hide().html(""),$(this).attr("isshow","0"))}),$("body").on("click",".face",function(t){t.stopPropagation(),function(t){if(a)if(window.getSelection){"0"!=m&&document.getElementById("text_div").focus(),a.collapse(!1);for(var e=a.createContextualFragment(t),i=e.lastChild;i&&"br"==i.nodeName.toLowerCase()&&i.previousSibling&&"br"==i.previousSibling.nodeName.toLowerCase();){var s=i;i=i.previousSibling,e.removeChild(s)}a.insertNode(e),i&&(a.setEndAfter(i),a.setStartAfter(i)),o.removeAllRanges(),o.addRange(a)}else"0"!=m&&document.getElementById("text_div").focus(),a.pasteHTML(t),a.collapse(!1),a.select();else $("#text_div").append(t);$(".msg_cont").removeClass("placeholder"),"0"==m&&($("#text_div").height()>24&&$("#text_div").css("bottom","6px"),$("#text_div").scrollTop($("#text_div")[0].scrollHeight),$("#text_div").blur())}($(this).html()),$(this).removeClass("placeholder")}),$("body").click(function(){"0"==m&&$(".session_main").css("top","0px"),$(".facelist").hide().html(""),$(".web_face").attr("isshow","0"),$(".show_box").hide()}),$(".reconnect_kefu,.wap_reconnect_kefu").click(function(){$(this).hide(),1==t&&1==e&&v("notgethistory")}),$("body").on("click",".load_message",function(){u.emit("user_no_wait",function(e){e&&(u.disconnect(),t=0,$(".session_main").hide(),$(".leave_word_main").show(),$(".leave_word_prompting").html("请留言，我们将在第一时间联系您"),self!=top&&_({key:"isrefresh",val:1}))})}),$("input[name='name']").bind("input propertychange",function(){f(),$("input[name='name']").next(".form_tip").remove(),$("input[name='name']").removeClass("textarea_input_red");var t=$("input[name='name']").val();$.form.isEmpty(t)?$(".name_img").show():$(".name_img").hide()}),$("input[name='name']").blur(function(){f();var t=$("input[name='name']").val();setTimeout(function(){$(".name_img").hide()},500),$.form.isEmpty(t)&&0!==t.replace(/ /g,"").length?($("input[name='name']").next(".form_tip").remove(),$("input[name='name']").removeClass("textarea_input_red")):($("input[name='name']").addClass("textarea_input_red"),$("input[name='name']").next(".form_tip").remove(),$("input[name='name']").after("<span class='form_tip' >姓名不可以为空</span>"))}),$("input[name='phone']").bind("input propertychange",function(){f(),$("input[name='phone']").next(".form_tip").remove(),$("input[name='phone']").removeClass("textarea_input_red"),""==$("input[name='phone']").val()?$(".phone_img").hide():$(".phone_img").show()}),$("input[name='phone']").blur(function(){f();var t=$("input[name='phone']").val();setTimeout(function(){$(".phone_img").hide()},500),$.form.isPhone(t)?($("input[name='phone']").next(".form_tip").remove(),$("input[name='phone']").removeClass("textarea_input_red")):($("input[name='phone']").addClass("textarea_input_red"),$("input[name='phone']").next(".form_tip").remove(),$("input[name='phone']").after("<span class='form_tip' >号码有误</span>"))}),$("input[name='email']").bind("input propertychange",function(){f(),$("input[name='email']").next(".form_tip").remove(),$("input[name='email']").removeClass("textarea_input_red");var t=$("input[name='email']").val();$.form.isEmpty(t)?$(".email_img").show():$(".email_img").hide()}),$("input[name='email']").blur(function(){f(),setTimeout(function(){$(".email_img").hide()},500);var t=$("input[name='email']").val();$.form.isEmpty(t)&&($.form.isEmail(t)?($("input[name='email']").next(".form_tip").remove(),$("input[name='email']").removeClass("textarea_input_red")):($("input[name='email']").addClass("textarea_input_red"),$("input[name='email']").next(".form_tip").remove(),$("input[name='email']").after("<span class='form_tip' >邮箱格式不正确</span>")))}),$("textarea[name='message']").bind("input propertychange",function(){f(),$("textarea[name='message']").next(".form_tip").remove(),$(".post_message_main").find("textarea").removeClass("textarea_input_red"),$(".message_text_num_span").html($(this).val().length),""!=$(this).val()?$(this).next("img").show():$(this).next("img").hide(),$(this).val().length>499?($(this).val($(this).val().substring(0,499)),$(".message_text_num").css("color","#fd3d39")):$(".message_text_num").css("color","#333")}),$(".clear_input").click(function(){$(this).prev("input").val(""),$(this).prev("textarea").val(""),$(this).hide()}),$("#send_message").click(function(){if("1"!=$("#send_message").attr("isclick")){var t=$("input[name='name']").val(),e=$("input[name='phone']").val(),i=$("input[name='email']").val(),s=$("textarea[name='message']").val(),n=y();if($(".form_tip").remove(),$(".post_message_main").find("input").removeClass("textarea_input_red"),$(".post_message_main").find("textarea").removeClass("textarea_input_red"),$.form.isEmpty(t))if($.form.isPhone(e))if($.form.isEmpty(i))if($.form.isEmail(i))if($.form.isEmpty(s)){h({name:t,mobile:e,email:i,content:s,userid:n})}else $("input[name='message']").addClass("textarea_input_red"),$("textarea[name='message']").after("<span class='form_tip'  style='position:relative;top:20px;' >留言内容不可以为空</span>");else $("input[name='email']").addClass("textarea_input_red"),$("input[name='email']").after("<span class='form_tip' >邮箱格式不正确</span>");else if($.form.isEmpty(s)&&0!==s.replace(/ /g,"").length){h({name:t,mobile:e,email:i,content:s,userid:n})}else $("input[name='message']").addClass("textarea_input_red"),$("textarea[name='message']").after("<span class='form_tip' style='position:relative;top:20px;'>留言内容不可以为空</span>");else $("input[name='phone']").addClass("textarea_input_red"),$("input[name='phone']").after("<span class='form_tip' >号码有误</span>");else $("input[name='name']").addClass("textarea_input_red"),$("input[name='name']").after("<span class='form_tip' >姓名不可以为空</span>")}}),$("body").on("click",".getMoreMsg",function(){var t=y(),e=$(".direct_chat_msg")[0].getAttribute("skipTime");$.ajax({type:"GET",url:l+"/cs/guest/getHistoryMessage",data:{userid:t,skipTime:e,role:"guest"},cache:!1,success:function(t){if(200==t.code){0==t.data.messages.length&&$(".getMoreMsg").html("没有更多消息了");for(var e=t.data.messages,i=0;i<e.length;i++){var s=e[i].role,a=e[i].time,o=e[i].content,r=e[i].type,c=e[i].from?e[i].from.uid&&e[i].from.uid.nickName?e[i].from.uid.nickName:e[i].from.aid&&e[i].from.aid.sender_nickname?e[i].from.aid.sender_nickname:"":"系统消息";if("1"==s)var m="left";else if("0"==s)m="right";else if("2"==s)m="center";if((n=n||a)-a>6e4){var l=C(0,"text","timestr",I(a));$(".getMoreMsg").parents(".direct-chat-msg").after(l),$(l)[0].scrollIntoView(!0)}var d=C(0,r,m,T(o),a,c);$(".getMoreMsg").parents(".direct-chat-msg").after(d),$(d)[0].scrollIntoView(!0),n=a}}}})}),0!=m&&$(".toolbar>div").hover(function(t){$(this).find("img").attr("src",$(this).find("img").attr("movesrc"))},function(){$(this).find("img").attr("src",$(this).find("img").attr("leavesrc"))}),$("#update_img").change(function(t){if(0!=i){var e=$("#update_img").prop("files");if(e[0])if(e[0].size>5242880)$.tip("请发送不超过5MB的图片");else{var s=e[0].name.split(".");if(/(gif|jpg|jpeg|png|bmp)$/.test(s[s.length-1].toLowerCase())){var n=Date.now();D(n);var a=new FileReader;a.onload=function(t){C(1,"image","right",t.target.result,n)},a.readAsDataURL(e[0]);var o=k(),r=new FormData;r.append("file",e[0]),r.append("roomID",o),$.ajax({url:l+"/cs/guest/upload",type:"POST",data:r,cache:!1,contentType:!1,processData:!1,success:function(t){if(200==t.code){$("#update_img").val("");var e=t.path;u.emit("chat_message",{content:e,type:"image",roomID:o,time:n},function(t){u.access||w(t,"notgethistory")})}}})}else $.tip("图片类型必须是.gif,jpeg,jpg,png中的一种")}}}),$("body").on("click",".msg_img",function(t){t.stopPropagation();var e=$(this).attr("src");if("0"==m)return $("#img_show").attr("src",e),void $(".img_plane").show();self!=top?_({key:"miHuaImgSrc",val:e}):($(".show_box").show(),$(".show_img").css("background-image","url("+e+")"))}),$(".plane_close").click(function(){$(".img_plane").hide()}),$(".img_plane").click(function(t){$(this).hide()}),$(".show_img_close").click(function(){$(".show_box").hide()}),$(".show_box").click(function(t){t.stopPropagation()}),window.onresize=function(){2==p.advertisement&&"0"!=m?($(".session_main_right").show(),document.body.offsetWidth<=800?($(".announcement_con").css("height","calc(100% - "+r+"px)"),$(".session_main").css("width","540px")):document.body.offsetWidth>800&&document.body.offsetWidth<=1350?($(".announcement_con").css("height","calc(100% - "+c+"px)"),$(".session_main").css("width","840px")):document.body.offsetWidth>1350&&($(".announcement_con").css("height","calc(100% - "+c+"px)"),$(".session_main").css("width","1075px"))):1==p.advertisement&&"0"!=m&&($(".session_main_right").hide(),document.body.offsetWidth<=800?$(".session_main").css("width","360px"):document.body.offsetWidth>800&&document.body.offsetWidth<=1350?$(".session_main").css("width","590px"):document.body.offsetWidth>1350&&$(".session_main").css("width","825px"))};var E="hidden"in document?"hidden":"webkitHidden"in document?"webkitHidden":"mozHidden"in document?"mozHidden":null,j=E.replace(/hidden/i,"visibilitychange"),M=function(t){document[E]?_({key:"startroasting",val:t}):_({key:"endroasting"})};document.addEventListener(j,function(t){document[E]||M()})});