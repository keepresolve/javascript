$(function(){var t,e,s,i,n,a,o,r=/Android|webOS|iPhone|iPad|BlackBerry/i.test(navigator.userAgent)?0:1;1==r&&(self!=top?($(".minimize").show(),$(".toggle").show(),console.log("嵌入页面:",window.location)):"model"==location.href.split("?")[1].split("=")[1]&&window.localStorage.removeItem("isopenmodelwindow"));var c="",l=["/::)","/::~","/::B","/::|","/:8-)","/::<","/::$","/::X","/::Z","/::'(","/::-|","/::@","/::P","/::D","/::O","/::(","/::+","/:--b","/::Q","/::T","/:,@P","/:,@-D","/::d","/:,@o","/::g","/:|-)","/::!","/::L","/::>","/::,@","/:,@f","/::-S","/:?","/:,@x","/:,@@","/::8","/:,@!","/:!!!","/:xx","/:bye","/:wipe","/:dig","/:handclap","/:&-(","/:B-)","/:<@","/:@>","/::-O","/:>-|","/:P-(","/::'|","/:X-)","/::*","/:@x","/:8*","/:pd","/:<W>","/:beer","/:basketb","/:oo","/:coffee","/:eat","/:pig","/:rose","/:fade","/:showlove","/:heart","/:break","/:cake","/:li","/:bome","/:kn","/:footb","/:ladybug","/:shit","/:moon","/:sun","/:gift","/:hug","/:strong","/:weak","/:share","/:v","/:@)","/:jj","/:@@","/:bad","/:lvu","/:no","/:ok","/:love","/:<L>","/:jump","/:shake","/:<O>","/:circle","/:kotow","/:turn","/:skip","/:oY","/:#-0","/:hiphot","/:kiss","/:<&","/:&>"],m={};$.ajax({type:"GET",url:c+"/epConfig/channelManage/query",data:{role:"guest",configData:"kefuIcon,cs_epname,advertisement,windowColor,advertisementPic,advertisementUrl,advertisementContent,conclusion,satisfaction,no_workingtime_alter"},cache:!1,success:function(t){if(console.log("企业配置:",t),200==t.code){if(m=t.data,window.parent.postMessage({key:"eConfig",val:m},"*"),m.cs_epname.length>15?$(".enterprise_name").html(m.cs_epname.substring(0,14)+"..."):$(".enterprise_name").html(m.cs_epname),m.kefuIcon)var e=c+m.kefuIcon;else e="img/eplogo.png";if($(".ep_logo").attr("src",e),$(".leave_word_prompting").html(m.no_workingtime_alter.web_context),"0"==r?($(".session_header,.leave_word_header,#send_message,.wap_reconnect_kefu").css("background",m.windowColor),$(".btn_enter").css({color:m.windowColor}),$("#text_div").css({caretColor:m.windowColor})):$(".session_header,.btn_enter,.leave_word_header,#send_message,.reconnect_kefu").css("background",m.windowColor),2==parseInt(m.advertisement)&&"0"!=r){if($(".session_main_right").show(),self!=top||document.body.offsetWidth<=800)var s=181;else s=251;if($(".session_main").css("width",$(".session_main").width()+s+"px"),void 0==m.advertisementUrl)var i=$('<a href="javascript:void(0)" >\t\t\t\t\t\t\t\t\t\t\t\t\t<img src="'+c+m.advertisementPic+'">\t\t\t\t\t\t\t\t\t\t\t\t</a>');else{if(m.advertisementUrl.indexOf("http://")>=0||m.advertisementUrl.indexOf("https://")>=0)var n=m.advertisementUrl;else n="http://"+m.advertisementUrl;i=$('<a target="_blank" href="'+n+'">\t\t\t\t\t\t\t\t\t\t\t<img src="'+c+m.advertisementPic+'">\t\t\t\t\t\t\t\t\t\t</a>')}var a=new Image;a.src=c+m.advertisementPic,a.onload=function(){var t=this.height/(this.width/160)+65;$(".announcement_con").css("height","calc(100% - "+t+"px)")},$(".announcement_pic").append(i),$(".announcement_con").html(m.advertisementContent)}else $(".session_main_right").hide()}}});var d=window.localStorage.getItem("emickfEpid")?window.localStorage.getItem("emickfEpid"):location.href.split("?")[1].split("=")[1],p=io(c+"/"+d);p.on("connect",function(s){t=1,e=1,console.log("socket连接状态:socket已连接"),h()}),p.on("chat_message",function(t){console.log("接收的消息:",t),$(".wait_prompting").remove(),y(Date.now());var e=t.content,s=t.time,i=t.type,n=t.nickName?t.nickName:"";2==t.role?I(1,"text","center",e):1==t.role?I(1,i,"left",C(e),s,n):0==t.role&&I(1,i,"right",C(e),s,""),f({key:"openchat"}),E({msg:C(e),name:n,icon:$(".ep_logo").attr("src"),type:i})}),p.on("close_session",function(t){console.log("关闭会话",t),console.log(m.conclusion.disabled),$(".direct-chat-messages").attr("roomID",x()),v(0),$("#typing_text").hide();var s=Date.now();m&&m.conclusion&&0==parseInt(m.conclusion.disabled)?I(1,"","closesession",t.content,s,t.nickName):I(1,"","closesession","",s,t.nickName),"0"!=r?$(".reconnect_kefu").show():$(".wap_reconnect_kefu").show(),e=1}),p.on("typing",function(t){console.log("typing事件",t),"1"==t.status?$("#typing_text").show():$("#typing_text").hide()}),p.on("disconnect",function(){t=0,v(0),console.log("Disconnected!")}),p.on("reconnect",function(){t=1,v(1),location.replace(location.href)}),p.on("reconnect_failed",function(){t=0,v(0),console.log("reconnect_failed")}),$("body").on("click",".score_btn",function(){var t=$(this).attr("val"),e=$(this).attr("roomID");p.emit("score",{roomID:e,score:t},function(t){}),$(this).parents(".direct-chat-text").find(".evaluation_button_box").hide(),$(this).parents(".direct-chat-text").find(".fk_jg").show()}),$(".minimize").click(function(){f({key:"close"})}),$(".toggle").click(function(){self!=top?f({key:"toggle"}):("model"==location.href.split("?")[1].split("=")[1]&&(localStorage.sessionwindowstyle=0),window.close())}),window.onbeforeunload=function(){self==top&&("model"==location.href.split("?")[1].split("=")[1]&&"1"!=localStorage.isopenmodelwindow&&(localStorage.sessionwindowstyle=0))},$(".btn_enter").click(function(){0!=s&&(""!=$(".msg_cont").html().replace("<br>","")&&w($(".msg_cont").html().replace(/<img [^>]*dataface=["]([^"]+)[^>]*>/gi,function(t,e){return e})))}),$(".msg_cont").keydown(function(t){if(0!=s)if(13!=t.which&&13!=t.keyCode);else{if(t.cancelBubble=!0,t.preventDefault(),t.stopPropagation(),""==$(".msg_cont").html().replace("<br>",""))return;w($(this).html().replace(/<img [^>]*dataface=["]([^"]+)[^>]*>/gi,function(t,e){return e}))}});function g(){if("0"!=r){var t=$("input[name='name']").val(),e=$("input[name='phone']").val(),s=$("textarea[name='message']").val();$.form.isEmpty(t)&&$.form.isPhone(e)&&s.length>0?$("#send_message").css("opacity","1"):$("#send_message").css("opacity","0.6")}}function u(t){$("#send_message").css("opacity","0.6"),$.post(c+"/cs/guest/createNoteMessage",t,function(){}),"0"!=r?($(".post_success_box").show(),$(".post_message_main").hide(),setTimeout(function(){f({key:"close"})},2e3)):($("#send_message").attr("isclick","1"),$.tip("提交成功"),setTimeout(function(){history.go(-1)},2e3))}function f(t){window.parent.postMessage(t,"*")}function h(t){var s=x(),i=b();null!==s&&"null"!==s||(s=null),null!==i&&"null"!==i||(i=null),console.log("用户开始登陆","roomID:"+s,"userID:"+i),p.emit("user_login",{browser:navigator.userAgent,roomID:s,userID:i},function(s){console.log(s),e=0,_(s,t)})}function _(e,s){if(-1!=e.access)return-2==e.access?(console.log("已创建房间但未分配客服"),p.access=!1,localStorage.setItem("roomID",e.roomID),localStorage.setItem("userID",e.userID),"notgethistory"!=s&&D(e.userID),void v(1)):void(0==e.access?($(".session_main").hide(),$(".leave_word_main").show(),e.userID&&localStorage.setItem("userID",e.userID),$(".leave_word_prompting").html("当前非工作时间，如需帮助请留言"),self!=top&&f({key:"isrefresh",val:1}),p.disconnect(),t=0):(v(1),localStorage.setItem("roomID",e.roomID),localStorage.setItem("userID",e.userID),p.access=!0,10==e.access?I(1,"text","access",e.msg):2==e.access?I(1,"text","leaveword",e.msg):1==e.access&&I(1,"text","leave_word",e.msg),"notgethistory"!=s&&D(e.userID)));console.log("服务器认为我们反复重连")}function v(t){s=t,0==t?($(".msg_send_mask").show(),$(".msg_cont").removeAttr("contenteditable"),$(".msg_cont").html(""),console.log("输入框不可编辑")):1==t&&($(".msg_send_mask").hide(),$(".msg_cont").attr("contenteditable",!0),console.log("输入框可编辑"))}function w(t){var e=Date.now(),s=x();p.emit("chat_message",{content:t,type:"text",roomID:s},function(t){console.log(t),p.access||(console.log("首次接入"),_(t,"notgethistory"))}),y(e),I(1,"text","right",C(t),e),$(".msg_cont").html(""),"0"==r&&$("#text_div").css("bottom","11px")}function x(){return window.localStorage.getItem("roomID")}function b(){return window.localStorage.getItem("userID")}function k(t){var e=new Date(t),s=e.getFullYear();(new Date).getFullYear()===s&&(s="");var i=e.getMonth()+1,n=e.getDate();(new Date).toDateString()===e.toDateString()&&(i="",n="");var a=e.getHours(),o=e.getMinutes(),r=e.getSeconds();return""!==i&&i<10&&(i="0"+i),""!==n&&n<10&&(n="0"+n),a<10&&(a="0"+a),o<10&&(o="0"+o),r<10&&(r="0"+r),[s+s?" ":""+i,i?"-":"",n," ",a,":",o,":",r].join("")}function y(t){var e=k(t);0==$(".timestr").length?I(1,"text","timestr",e):t-(i=i||Date.now())>6e4&&I(1,"text","timestr",e);i=t}function I(t,e,s,i,n,a){switch("right"==s&&(a=""),s){case"timestr":var o=$('<div class="direct-chat-msg timestr msg_center">\t\t\t\t\t\t\t<div>\t\t\t\t\t\t\t\t<span class="">'+i+"</span>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>");break;case"center":o=$('<div class="direct-chat-msg  msg_center">\t\t\t\t\t\t\t<div>\t\t\t\t\t\t\t\t<span class="">'+i+"</span>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>");break;case"access":o=$('<div class="direct-chat-msg  access_user msg_center">\t\t\t\t\t\t\t<div>\t\t\t\t\t\t\t\t<span class="">'+i+"</span>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>");break;case"leaveword":o=$('<div class="direct-chat-msg  msg_center wait_prompting">\t\t\t\t\t\t\t<div>\t\t\t\t\t\t\t\t<span class="">前面还有 <span style="color:#FD3D39">'+i+'</span> 位在排队 ! 您可以<a class="load_message" href="javascript:void(0)">转为留言</a></span>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>');break;case"leave_word":o=$('<div class="direct-chat-msg  msg_center wait_prompting">\t\t\t\t\t\t\t<div>\t\t\t\t\t\t\t\t<span class="">当前没有客服在线，</span><span class="">你也可以 <a class="load_message" href="javascript:void(0)">转为留言</a>, 客服会在第一时间联系您</span>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>');break;case"closesession":o=$('<div class="direct-chat-msg  direct_chat_msg left msg_left" skipTime="'+n+'">\t\t\t\t\t\t\t<div class="direct-chat-info pull-left direct-chat-info-name">'+a+'</div>\t\t\t\t\t\t\t<div class="direct-chat-text">\t\t\t\t\t\t\t\t<div>'+i+'</div>\t\t\t\t\t\t\t\t<div class="fk_jg" style="display:none;">感谢您的反馈</div>\t\t\t\t\t\t\t\t<div class="evaluation_button_box">\t\t\t\t\t\t\t\t\t<span style="font-size: 12px;color: #888888;letter-spacing: -0.6px;">是否解决了您的问题：</span>\t\t\t\t\t\t\t\t\t<div class="score_btn" roomID="'+x()+'"  style="float:left" val="2">\t\t\t\t\t\t\t\t\t\t<img style="margin-left: 15px;position:relative;top:1px;" src="img/e_up.png">\t\t\t\t\t\t\t\t\t\t<span>解决</span>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t<div class="score_btn" roomID="'+x()+'" style="float:right" val="1">\t\t\t\t\t\t\t\t\t\t<img style="margin-left: 10px;position:relative;top:3px;" src="img/e_down.png">\t\t\t\t\t\t\t\t\t\t<span>未解决</span>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>');console.log("会话结束，重置roomid"),window.localStorage.removeItem("roomID"),""==i&&o.find(".evaluation_button_box").css("margin-top","0px");break;default:switch(e){case"text":o=$('<div class="direct-chat-msg  direct_chat_msg '+s+" msg_"+s+'" skipTime="'+n+'">\t\t\t\t\t\t\t<div class="direct-chat-info pull-'+s+' direct-chat-info-name">'+a+'</div>\t\t\t\t\t\t\t<div class="direct-chat-text">'+i+"</div>\t\t\t\t\t\t</div>");break;case"file":o=$('<div class="direct-chat-msg  direct_chat_msg '+s+" msg_"+s+'" skipTime="'+n+'">\t\t\t\t\t\t\t\t<div class="direct-chat-info pull-'+s+' direct-chat-info-name">'+a+'</div>\t\t\t\t\t\t\t\t<div class="direct-chat-text" dataurl="'+i+'">\t\t\t\t\t\t\t\t\t<img class="msg_file" src="img/photo1.png">\t\t\t\t\t\t\t\t\t<div class="msg_file_des">\t\t\t\t\t\t\t\t\t\t<div class="file_name">问题集合.text</div>\t\t\t\t\t\t\t\t\t\t<div class="file_size">1.3M</div>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>');break;case"image":o=$('<div class="direct-chat-msg  direct_chat_msg '+s+" msg_"+s+'" skipTime="'+n+'">\t\t\t\t\t\t\t\t<div class="direct-chat-info pull-'+s+' direct-chat-info-name">'+a+'</div>\t\t\t\t\t\t\t\t<div class="direct-chat-text"  >\t\t\t\t\t\t\t\t\t<img class="msg_img" src="'+c+i+'">\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>')}}if(1!=t)return o;$(".direct-chat-messages").append(o),$(o)[0].scrollIntoView(!0),$(".direct-chat-messages").scrollTop($(".direct-chat-messages").get(0).scrollHeight-$(".direct-chat-messages").get(0).offsetHeight)}function D(t){$.ajax({type:"GET",url:c+"/cs/guest/getHistoryMessage",data:{userid:t,role:"guest"},cache:!1,success:function(t){console.log("历史消息:",t),200==t.code&&function(t){var e=t.data.messages;console.log("会话数据:",e);for(var s=0;s<e.length;s++){var i=e[s].role,a=e[s].time,o=e[s].type,r=e[s].content;if("1"==i)var l="left",m=e[s].from?e[s].from.uid&&e[s].from.uid.nickName?e[s].from.uid.nickName:e[s].from.aid&&e[s].from.aid.sender_nickname?e[s].from.aid.sender_nickname:"":"系统消息";else if("0"==i)var l="right";else if("2"==i)var l="center";var d=(n=n||a)-a;if(d>6e4){var p=I(0,"text","timestr",k(a));$(".direct-chat-messages").prepend(p)}var g=I(0,o,l,C(r),a,m);if("image"==o){var u=new Image;u.src=c+r,u.onload=function(){$(".access_user")[0]?$(".access_user")[0].scrollIntoView(!0):$(".wait_prompting")[0]&&$(".wait_prompting")[0].scrollIntoView(!0)}}$(".direct-chat-messages").prepend(g),n=a}if(e.length>11){var g=I(0,"text","center",'<a class="getMoreMsg">查看更多</a>');$(".direct-chat-messages").prepend(g)}$(".direct-chat-msg").length>0&&$(".direct-chat-msg")[$(".direct-chat-msg").length-1].scrollIntoView(!0)}(t)}})}function C(t){var e=new RegExp("(/::\\)|/::~|/::B|/::\\||/:8-\\)|/::<|/::\\$|/::X|/::Z|/::'\\(|/::-\\||/::@|/::P|/::D|/::O|/::\\(|/::\\+|/:--b|/::Q|/::T|/:,@P|/:,@-D|/::d|/:,@o|/::g|/:\\|-\\)|/::!|/::L|/::>|/::,@|/:,@f|/::-S|/:\\?|/:,@x|/:,@@|/::8|/:,@!|/:!!!|/:xx|/:bye|/:wipe|/:dig|/:handclap|/:&-\\(|/:B-\\)|/:<@|/:@>|/::-O|/:>-\\||/:P-\\(|/::'\\||/:X-\\)|/::\\*|/:@x|/:8\\*|/:pd|/:<W>|/:beer|/:basketb|/:oo|/:coffee|/:eat|/:pig|/:rose|/:fade|/:showlove|/:heart|/:break|/:cake|/:li|/:bome|/:kn|/:footb|/:ladybug|/:shit|/:moon|/:sun|/:gift|/:hug|/:strong|/:weak|/:share|/:v|/:@\\)|/:jj|/:@@|/:bad|/:lvu|/:no|/:ok|/:love|/:<L>|/:jump|/:shake|/:<O>|/:circle|/:kotow|/:turn|/:skip|/:oY|/:#-0|/:hiphot|/:kiss|/:<&|/:&>)","g");return t.replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(e,function(t,e){var s=l.indexOf(t)+1;return s<10&&(s="0"+s),'<img src="plugins/emoji/face/'+s+'.gif">'})}$(".msg_cont").focus(function(){navigator.userAgent.indexOf("iphone")>-1&&setTimeout(function(){window.scrollTo(0,$("body").height()),$(".direct-chat-messages").scrollTop($(".direct-chat-messages").get(0).scrollHeight-$(".direct-chat-messages").height())},500),$(this).removeClass("placeholder"),p.emit("typing",{status:1,roomID:x()})}),$(".msg_cont").blur(function(){""==$(this).html()?$(this).addClass("placeholder"):$(this).removeClass("placeholder"),p.emit("typing",{status:0,roomID:x()})}),$(".msg_cont").mouseleave(function(){var t=window.getSelection?window.getSelection():document.selection;t.focusNode&&t.focusNode.parentNode&&"text_div"===t.focusNode.parentNode.id&&(a=(o=t).createRange?o.createRange():o.getRangeAt(0))}),$(".web_face").click(function(t){if(t.stopPropagation(),"0"!=r?document.getElementById("text_div").focus():document.getElementById("text_div").blur(),0==$(this).attr("isshow")){"0"==r&&$(".session_main").css("top","-257px");for(var e="0"==r?30:104,s=1;s<e;s++){var i=s-1;s<10&&(s="0"+s);var n=$('<li class="face pull_left" >\t\t\t\t\t\t<img dataface="'+l[i]+'" src="plugins/emoji/face/'+s+'.gif">\t\t\t\t\t</li>');$(".facelist").append(n)}$(".facelist").show(),$(this).attr("isshow","1")}else 1==$(this).attr("isshow")&&("0"==r&&$(".session_main").css("top","0px"),$(".facelist").hide().html(""),$(this).attr("isshow","0"))}),$("body").on("click",".face",function(t){t.stopPropagation(),function(t){if(a)if(window.getSelection){document.getElementById("text_div").focus(),a.collapse(!1);for(var e=a.createContextualFragment(t),s=e.lastChild;s&&"br"==s.nodeName.toLowerCase()&&s.previousSibling&&"br"==s.previousSibling.nodeName.toLowerCase();){var i=s;s=s.previousSibling,e.removeChild(i)}a.insertNode(e),s&&(a.setEndAfter(s),a.setStartAfter(s)),o.removeAllRanges(),o.addRange(a)}else document.getElementById("text_div").focus(),a.pasteHTML(t),a.collapse(!1),a.select();else $("#text_div").append(t),$("#text_div").scrollTop($("#text_div")[0].scrollHeight);"0"==r&&($("#text_div").height()>24&&$("#text_div").css("bottom","0px"),$("#text_div").blur())}($(this).html()),$(this).removeClass("placeholder")}),$("body").click(function(){"0"==r&&$(".session_main").css("top","0px"),$(".facelist").hide().html(""),$(".web_face").attr("isshow","0"),$(".show_box").hide()}),$(".reconnect_kefu,.wap_reconnect_kefu").click(function(){$(this).hide(),1==t&&1==e&&h("notgethistory")}),$("body").on("click",".load_message",function(){p.emit("user_no_wait",function(e){console.log(e),e&&(p.disconnect(),t=0,$(".session_main").hide(),$(".leave_word_main").show(),$(".leave_word_prompting").html("请留言，我们将在第一时间联系您"),self!=top&&f({key:"isrefresh",val:1}))})}),$("input[name='name']").bind("input propertychange",function(){g(),$("input[name='name']").next(".form_tip").remove(),$("input[name='name']").removeClass("textarea_input_red");var t=$("input[name='name']").val();$.form.isEmpty(t)?$(".name_img").show():$(".name_img").hide()}),$("input[name='name']").blur(function(){g();var t=$("input[name='name']").val();setTimeout(function(){$(".name_img").hide()},500),$.form.isEmpty(t)&&0!==t.replace(/ /g,"").length?($("input[name='name']").next(".form_tip").remove(),$("input[name='name']").removeClass("textarea_input_red")):($("input[name='name']").addClass("textarea_input_red"),$("input[name='name']").next(".form_tip").remove(),$("input[name='name']").after("<span class='form_tip' >姓名不可以为空</span>"))}),$("input[name='phone']").bind("input propertychange",function(){g(),$("input[name='phone']").next(".form_tip").remove(),$("input[name='phone']").removeClass("textarea_input_red"),""==$("input[name='phone']").val()?$(".phone_img").hide():$(".phone_img").show()}),$("input[name='phone']").blur(function(){g();var t=$("input[name='phone']").val();setTimeout(function(){$(".phone_img").hide()},500),$.form.isPhone(t)?($("input[name='phone']").next(".form_tip").remove(),$("input[name='phone']").removeClass("textarea_input_red")):($("input[name='phone']").addClass("textarea_input_red"),$("input[name='phone']").next(".form_tip").remove(),$("input[name='phone']").after("<span class='form_tip' >号码有误</span>"))}),$("input[name='email']").bind("input propertychange",function(){g(),$("input[name='email']").next(".form_tip").remove(),$("input[name='email']").removeClass("textarea_input_red");var t=$("input[name='email']").val();$.form.isEmpty(t)?$(".email_img").show():$(".email_img").hide()}),$("input[name='email']").blur(function(){g(),setTimeout(function(){$(".email_img").hide()},500);var t=$("input[name='email']").val();$.form.isEmpty(t)&&($.form.isEmail(t)?($("input[name='email']").next(".form_tip").remove(),$("input[name='email']").removeClass("textarea_input_red")):($("input[name='email']").addClass("textarea_input_red"),$("input[name='email']").next(".form_tip").remove(),$("input[name='email']").after("<span class='form_tip' >邮箱格式不正确</span>")))}),$("textarea[name='message']").bind("input propertychange",function(){g(),$("textarea[name='message']").next(".form_tip").remove(),$(".post_message_main").find("textarea").removeClass("textarea_input_red"),$(".message_text_num_span").html($(this).val().length),""!=$(this).val()?$(this).next("img").show():$(this).next("img").hide(),$(this).val().length>499?($(this).val($(this).val().substring(0,499)),$(".message_text_num").css("color","#fd3d39")):$(".message_text_num").css("color","#333")}),$(".clear_input").click(function(){$(this).prev("input").val(""),$(this).prev("textarea").val(""),$(this).hide()}),$("#send_message").click(function(){if("1"!=$("#send_message").attr("isclick")){var t=$("input[name='name']").val(),e=$("input[name='phone']").val(),s=$("input[name='email']").val(),i=$("textarea[name='message']").val(),n=b();if($(".form_tip").remove(),$(".post_message_main").find("input").removeClass("textarea_input_red"),$(".post_message_main").find("textarea").removeClass("textarea_input_red"),$.form.isEmpty(t))if($.form.isPhone(e))if($.form.isEmpty(s))if($.form.isEmail(s))if($.form.isEmpty(i)){u({name:t,mobile:e,email:s,content:i,userid:n})}else $("input[name='message']").addClass("textarea_input_red"),$("textarea[name='message']").after("<span class='form_tip'  style='position:relative;top:20px;' >留言内容不可以为空</span>");else $("input[name='email']").addClass("textarea_input_red"),$("input[name='email']").after("<span class='form_tip' >邮箱格式不正确</span>");else if($.form.isEmpty(i)&&0!==i.replace(/ /g,"").length){u({name:t,mobile:e,email:s,content:i,userid:n})}else $("input[name='message']").addClass("textarea_input_red"),$("textarea[name='message']").after("<span class='form_tip' style='position:relative;top:20px;'>留言内容不可以为空</span>");else $("input[name='phone']").addClass("textarea_input_red"),$("input[name='phone']").after("<span class='form_tip' >号码有误</span>");else $("input[name='name']").addClass("textarea_input_red"),$("input[name='name']").after("<span class='form_tip' >姓名不可以为空</span>")}}),$("body").on("click",".getMoreMsg",function(){var t=b(),e=$(".direct_chat_msg")[0].getAttribute("skipTime");console.log(t,e),$.ajax({type:"GET",url:c+"/cs/guest/getHistoryMessage",data:{userid:t,skipTime:e,role:"guest"},cache:!1,success:function(t){if(console.log("历史消息:",t),200==t.code){0==t.data.messages.length&&$(".getMoreMsg").html("没有更多消息了");for(var e=t.data.messages,s=0;s<e.length;s++){var i=e[s].role,a=e[s].time,o=e[s].content,r=e[s].type,c=e[s].from?e[s].from.uid&&e[s].from.uid.nickName?e[s].from.uid.nickName:e[s].from.aid&&e[s].from.aid.sender_nickname?e[s].from.aid.sender_nickname:"":"系统消息";if("1"==i)var l="left";else if("0"==i)l="right";else if("2"==i)l="center";if((n=n||a)-a>6e4){var m=I(0,"text","timestr",k(a));$(".getMoreMsg").parents(".direct-chat-msg").after(m),$(m)[0].scrollIntoView(!0)}var d=I(0,r,l,C(o),a,c);$(".getMoreMsg").parents(".direct-chat-msg").after(d),$(d)[0].scrollIntoView(!0),n=a}}}})}),0!=r&&$(".toolbar>div").hover(function(t){$(this).find("img").attr("src",$(this).find("img").attr("movesrc"))},function(){$(this).find("img").attr("src",$(this).find("img").attr("leavesrc"))}),$("#update_img").change(function(t){if(0!=s){var e=$("#update_img").prop("files");if(e[0])if(e[0].size>5242880)$.tip("请发送不超过5MB的图片");else{var i=e[0].name.split(".");if(/(gif|jpg|jpeg|png|bmp)$/.test(i[i.length-1].toLowerCase())){var n=Date.now();y(n);var a=new FileReader;a.onload=function(t){I(1,"image","right",t.target.result,n)},a.readAsDataURL(e[0]);var o=x(),r=new FormData;r.append("file",e[0]),r.append("roomID",o),$.ajax({url:c+"/cs/guest/upload",type:"POST",data:r,cache:!1,contentType:!1,processData:!1,success:function(t){if(console.log("文件上传",t),200==t.code){$("#update_img").val("");var e=t.path;p.emit("chat_message",{content:e,type:"image",roomID:o,time:n},function(t){console.log(t),p.access||(console.log("首次接入"),_(t,"notgethistory"))})}}})}else $.tip("图片类型必须是.gif,jpeg,jpg,png中的一种")}}}),$("body").on("click",".msg_img",function(t){t.stopPropagation();var e=$(this).attr("src");if("0"==r)return $("#img_show").attr("src",e),void $(".img_plane").show();self!=top?f({key:"miHuaImgSrc",val:e}):($(".show_box").show(),$(".show_img").css("background-image","url("+e+")"))}),$(".plane_close").click(function(){$(".img_plane").hide()}),$(".img_plane").click(function(t){$(this).hide()}),$(".show_img_close").click(function(){$(".show_box").hide()}),$(".show_box").click(function(t){t.stopPropagation()}),window.onresize=function(){2==m.advertisement&&"0"!=r?($(".session_main_right").show(),document.body.offsetWidth<=800?$(".session_main").css("width","540px"):document.body.offsetWidth>800&&document.body.offsetWidth<=1350?$(".session_main").css("width","840px"):document.body.offsetWidth>1350&&$(".session_main").css("width","1075px")):1==m.advertisement&&"0"!=r&&($(".session_main_right").hide(),document.body.offsetWidth<=800?$(".session_main").css("width","360px"):document.body.offsetWidth>800&&document.body.offsetWidth<=1350?$(".session_main").css("width","590px"):document.body.offsetWidth>1350&&$(".session_main").css("width","825px"))};var S="hidden"in document?"hidden":"webkitHidden"in document?"webkitHidden":"mozHidden"in document?"mozHidden":null,T=S.replace(/hidden/i,"visibilitychange"),E=function(t){document[S]?f({key:"startroasting",val:t}):f({key:"endroasting"})};document.addEventListener(T,function(t){document[S]||E()})});