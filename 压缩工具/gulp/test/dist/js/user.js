$(function(){var i,s,r,a,v,n,o,_,c=/Android|iPhone|iPad/i.test(navigator.userAgent)?0:1,w=require("debug")("user:embed");if(w("0是移动端，1是PC端 : "+c),1==c)if(self!=top){$(".minimize").show(),$(".toggle").show();var t=location.href.match(/emickfEpid=(.*)/)[1];w("嵌入页面:",location)}else{var e=location.href.match(/toggle=(.*)&&/)[1];t=location.href.match(/emickfEpid=(.*)/)[1];w("企业id"+t),"model"==e&&$(".toggle").show()}else t=location.href.match(/epid=(.*)/)[1];var l,m,d,b={},x="",p=["/::)","/::~","/::B","/::|","/:8-)","/::<","/::$","/::X","/::Z","/::'(","/::-|","/::@","/::P","/::D","/::O","/::(","/::+","/:--b","/::Q","/::T","/:,@P","/:,@-D","/::d","/:,@o","/::g","/:|-)","/::!","/::L","/::>","/::,@","/:,@f","/::-S","/:?","/:,@x","/:,@@","/::8","/:,@!","/:!!!","/:xx","/:bye","/:wipe","/:dig","/:handclap","/:&-(","/:B-)","/:<@","/:@>","/::-O","/:>-|","/:P-(","/::'|","/:X-)","/::*","/:@x","/:8*","/:pd","/:<W>","/:beer","/:basketb","/:oo","/:coffee","/:eat","/:pig","/:rose","/:fade","/:showlove","/:heart","/:break","/:cake","/:li","/:bome","/:kn","/:footb","/:ladybug","/:shit","/:moon","/:sun","/:gift","/:hug","/:strong","/:weak","/:share","/:v","/:@)","/:jj","/:@@","/:bad","/:lvu","/:no","/:ok","/:love","/:<L>","/:jump","/:shake","/:<O>","/:circle","/:kotow","/:turn","/:skip","/:oY","/:#-0","/:hiphot","/:kiss","/:<&","/:&>"],g={};$.ajax({type:"GET",url:x+"/epConfig/channelManage/query",data:{role:"guest",configData:"kefuIcon,cs_epname,advertisement,windowColor,advertisementPic,advertisementUrl,advertisementContent,conclusion,satisfaction,no_workingtime_alter,hasRobot"},cache:!1,success:function(t){if(w("企业配置:",t),200==t.code){if(1===t.data.hasRobot&&(b.is_has_robot=1),D({key:"eConfig",val:(g=t.data).advertisement}),$(".enterprise_name").html(g.cs_epname),g.kefuIcon&&1!=b.is_has_robot)var e=x+g.kefuIcon;if($(".ep_logo").attr("src",e),$(".leave_word_prompting").html(g.no_workingtime_alter.web_context),"0"==c?($(".session_header,.leave_word_header,#send_message,.wap_reconnect_kefu").css("background",g.windowColor),$(".btn_enter").css({color:g.windowColor}),$("#text_div").css({caretColor:g.windowColor})):$(".session_header,.btn_enter,.leave_word_header,#send_message,.reconnect_kefu").css("background",g.windowColor),2==parseInt(g.advertisement)&&"0"!=c){if($(".session_main_right").show(),self!=top||document.body.offsetWidth<=800)var i=181;else i=251;if($(".session_main").css("width",$(".session_main").width()+i+"px"),null==g.advertisementUrl)var s=$('<a href="javascript:void(0)" >\t\t\t\t\t\t\t\t\t\t\t\t\t<img src="'+x+g.advertisementPic+'">\t\t\t\t\t\t\t\t\t\t\t\t</a>');else{if(0<=g.advertisementUrl.indexOf("http://")||0<=g.advertisementUrl.indexOf("https://"))var a=g.advertisementUrl;else a="http://"+g.advertisementUrl;s=$('<a target="_blank" href="'+a+'">\t\t\t\t\t\t\t\t\t\t\t<img src="'+x+g.advertisementPic+'">\t\t\t\t\t\t\t\t\t\t</a>')}var n=new Image;n.src=x+g.advertisementPic,n.onload=function(){m=this.height/(this.width/160)+35,d=this.height/(this.width/230)+35,$(".announcement_con").css("height","calc(100% - "+m+"px)")},$(".announcement_pic").append(s),$(".announcement_con").html(g.advertisementContent)}else $(".session_main_right").hide()}}}),w(t);var h=io(x+"/"+t);function f(){w("点击转人工或者重连客服的时候要查是不是起了这个timer:"+s),s&&(w("取消timer"),clearTimeout(s),s=!1)}function u(e){f(),h.connected?(w("socket connected so swith to staff service"),h.emit("switchPosition",{roomID:S()},function(t){w(t),e&&$(".completeList")&&$(".completeList").hide(),T(t,"notgethistory")})):(w("socket NOT connected so connect first before swith to staff service"),i=e?3:4,h.connect())}w("created a socket:"+h.id),w("没有强制用websocket"),h.on("connect",function(t){switch(w("socket连接状态:"+h.id+": "+h.connected),C(1),i){case 2:w("重连socket"),I("notgethistory");break;case 3:w("重连socket后转人工"),u(3);break;case 4:w("重连socket后转人工"),u();break;default:I()}}),h.on("chat_message",function(t){11!=t.isAccess&&10!=t.isAccess||O(1),w("接收的消息:",t),L(Date.now());var e=t.content,i=t.time,s=t.type,a=t.answerType,n=t.nickName?t.nickName:"";if(2==t.role)P(1,"operation","center",e),$(".wait_prompting").remove();else if(1==t.role)P(1,s,"left",H(e),i,n),$(".wait_prompting").remove();else if(0==t.role)P(1,s,"right",H(e),i,"");else if(3==t.role){n=b.robotName?b.robotName:"易米小超人";1==t.answerType?P(1,"operation","robotscore",t,i,n,1):2==t.answerType?P(1,"operation","answerobj",t,i,n):3==t.answerType?P(1,"operation","questionList",e,i,n,1):4==t.answerType?P(1,"operation","switchposition",e,i,n):6==t.answerType&&P(1,"operation","robotscore",t,i,n,0)}D({key:"openchat"}),3!=t.role&&B({msg:H(e),name:n,icon:$(".ep_logo").attr("src"),type:s,answerType:a})}),h.on("close_session",function(t){w("关闭会话",t);var e,i=Date.now();$(".direct-chat-messages").attr("roomID",S()),$("#typing_text").hide(),C(0),g&&g.conclusion&&0==parseInt(g.conclusion.disabled)?1==t.code?P(1,"operation","robotclosesession",t.content,i,t.nickName):P(1,"operation","closesession",t.content,i,t.nickName):1==t.code?P(1,"operation","robotclosesession","会话已结束,感谢您的咨询",i,t.nickName):P(1,"operation","closesession","会话已结束,感谢您的咨询",i,t.nickName),"0"!=c?$(".reconnect_kefu").show():$(".wap_reconnect_kefu").show(),1==t.code?(w("机器人超时，不用评价，所以关闭socket"),h.disconnect()):(w("还需要用户发评价，所以此时不能关闭socket"),e=h.id,w("要关闭的socket id:"+e),s=setTimeout(function(){h.connected?(w("三分钟后还没关闭，认为用户也想不点评价了，我们关闭socket"),h.id==e?(w("确实还是这个socket，关闭它"),h.disconnect()):w("好像我们取消timer都考虑到后，这种情况不存了：socket id已变:"+h.id),s=!1):w("看来用户评价了，所以已经关闭socket")},18e4))}),h.on("typing",function(t){w("typing事件",t),"1"==t.status?$("#typing_text").show():$("#typing_text").hide()}),h.on("disconnect",function(){C(0),w("disconnect:"+h.id)}),h.on("reconnect",function(){w("reconnect:"+h.id),location.replace(location.href)}),h.on("reconnect_failed",function(){C(0),w("reconnect_failed:"+h.id)}),h.on("reconnect_attempt",function(t){w("reconnect_attempt:"+h.id)}),h.on("reconnecting",function(t){w("reconnecting:"+h.id)}),$(".switch_position").click(function(){u("completeList")}),$("body").on("click",".switchPosition",function(){u()}),$(".completeList").mouseover(function(){$(".activequestion").removeClass("activequestion")}),$(".completeList").mouseout(function(){$(this).children(".completeEl:first-child").addClass("activequestion")}),$("body").on("click",".robot_question",function(){0!=r&&j($(this).attr("message"))}),$("body").on("click",".completeEl",function(){j($(this).attr("message"))}),$("#text_div").bind("input propertychange",function(){if(0!=c&&1!=l){var a,t=$(this).text().replace(/<.*?>/gi,"");w(t),a=t,$.ajax({type:"GET",url:x+"/cs/guest/autoComplete",data:{question:a},cache:!1,success:function(t){if(w("自动补全消息:",t),200==t.code){$(".completeList").show().html("");for(var e=0;e<t.message.length;e++){var i=t.message[e].question.replace(a,'<span class="colorRed" >'+a+"</span>");if(0==e)var s=$('<div message="'+t.message[e].question+'" class="completeEl activequestion">'+i+"</div>");else var s=$('<div message="'+t.message[e].question+'" class="completeEl">'+i+"</div>");$(".completeList").append(s)}}}})}}),$("body").on("click",".evaluation_btn",function(){var t=$(this).attr("val"),e=$(this).parents(".direct_chat_msg").attr("skipTime"),i=$(this).parents(".direct_chat_msg").attr("aid"),s=$(this).parents(".direct_chat_msg").attr("cluid"),a=$(this).attr("roomID"),n=$(this).parents(".direct-chat-msg").prev(".direct-chat-msg").find(".direct-chat-text").html();h.emit("robotscore",{roomID:a,userID:M(),isHelp:t,time:e,question:n,aid:i,cluid:s},function(t){w("已发机器人评价，不关闭socket")}),$(this).parents(".ans_evaluation").hide(),$(this).parents(".direct-chat-text").find(".fk_jg").show()}),$("body").on("click",".score_btn",function(){var t=$(this).attr("val"),e=$(this).attr("roomID");h.emit("score",{roomID:e,score:t},function(t){w("可能是对以前的会话做评价，所以不要关闭socket,交由closeSocketTimer处理:"+s)}),$(this).parents(".direct-chat-text").find(".evaluation_button_box").hide(),$(this).parents(".direct-chat-text").find(".fk_jg").show()}),$(".minimize").click(function(){D({key:"close"})}),$(".toggle").click(function(){self!=top?D({key:"toggle",val:1}):"model"==location.href.split("?")[1].split("&&")[0].split("=")[1]&&(window.close(),D({key:"toggle",val:0}))}),$("#text_div").on("paste",function(){setTimeout(function(){$("#text_div").text($("#text_div").text())},100)}),$(".btn_enter").click(function(){0!=r&&(""!=$(".msg_cont").html().replace("<br>","").replace(/&nbsp;/g,"")&&j($(".msg_cont").html().replace(/<img [^>]*dataface=["]([^"]+)[^>]*>/gi,function(t,e){return e})))}),$(".msg_cont").keydown(function(t){if(0!=r&&(13==t.which||13==t.keyCode))return t.cancelBubble=!0,t.preventDefault(),t.stopPropagation(),""==$(".msg_cont").html().replace("<br>","").replace(/\s+/g,"").replace(/&nbsp;+/g,"")?void $(this).html(""):void j($(this).html().replace(/<img [^>]*dataface=["]([^"]+)[^>]*>/gi,function(t,e){return e}))});function k(){if("0"!=c){var t=$("input[name='name']").val(),e=$("input[name='phone']").val(),i=$("textarea[name='message']").val();$.form.isEmpty(t)&&$.form.isPhone(e)&&0<i.length?$("#send_message").css("opacity","1"):$("#send_message").css("opacity","0.6")}}function y(t){$("#send_message").css("opacity","0.6"),$.post(x+"/cs/guest/createNoteMessage",t,function(){}),"0"!=c?($(".post_success_box").show(),$(".post_message_main").hide(),setTimeout(function(){D({key:"close"})},2e3)):($("#send_message").attr("isclick","1"),$.tip("提交成功"),setTimeout(function(){history.go(-1)},2e3))}function D(t){w("send parent window:"+JSON.stringify(t)),(window.opener||window.parent).postMessage(t,"*")}function I(e){var t=S(),i=M();null!==t&&"null"!==t||(t=null),null!==i&&"null"!==i||(i=null),w("用户开始登陆","roomID:"+t,"userID:"+i),h.emit("user_login",{browser:navigator.userAgent,roomID:t,userID:i},function(t){w(t),(t.robotName||t.logoUrl)&&(b.is_has_robot=1),t.robotName&&(b.robotName=t.robotName),t.logoUrl&&$(".ep_logo").attr("src",t.logoUrl),T(t,e)})}function T(t,e){if(-2==t.access)return l=1,w("已创建房间但未分配客服"),h.access=!1,localStorage.setItem("roomID",t.roomID),localStorage.setItem("userID",t.userID),"notgethistory"!=e&&q(t.userID),void C(1);0==t.access?($(".session_main").hide(),$(".leave_word_main").show(),t.userID&&localStorage.setItem("userID",t.userID),$(".leave_word_prompting").html("当前非工作时间，如需帮助请留言"),self!=top&&D({key:"isrefresh",val:1}),h.disconnect()):(C(1),localStorage.setItem("roomID",t.roomID),localStorage.setItem("userID",t.userID),h.access=!0,3==t.access?h.access=!1:10==t.access?P(1,"operation","access",t.msg):2==t.access?P(1,"operation","leaveword",t.msg):1==t.access&&P(1,"operation","leave_word",t.msg),"notgethistory"!=e&&q(t.userID)),10==t.access||11==t.access||1==t.access||2==t.access?O(1):O(0)}function C(t){0==(r=t)?($(".msg_send_mask").show(),$(".msg_cont").removeAttr("contenteditable"),$(".msg_cont").html(""),w("输入框不可编辑")):1==t&&($(".msg_send_mask").hide(),$(".msg_cont").attr("contenteditable",!0),w("输入框可编辑"))}function j(t){var e=Date.now(),i=S();h.emit("chat_message",{content:JSON.stringify(t).substring(1,JSON.stringify(t).length-1).replace(/\\t/g,""),type:"text",roomID:i},function(t){w(t),w(h.access),h.access||(w("首次接入"),T(t,"notgethistory"))}),L(e),P(1,"text","right",H(t),e),$(".msg_cont").html(""),"0"==c&&$("#text_div").css("bottom","14px"),setTimeout(function(){$(".completeList").hide()},100)}function N(){w("会话结束，重置roomid"),window.localStorage.removeItem("roomID")}function S(){return window.localStorage.getItem("roomID")}function M(){return window.localStorage.getItem("userID")}function E(t){var e=new Date(t),i=e.getFullYear();(new Date).getFullYear()===i&&(i="");var s=e.getMonth()+1,a=e.getDate();(new Date).toDateString()===e.toDateString()&&(a=s="");var n=e.getHours(),o=e.getMinutes(),r=e.getSeconds();return""!==s&&s<10&&(s="0"+s),""!==a&&a<10&&(a="0"+a),n<10&&(n="0"+n),o<10&&(o="0"+o),r<10&&(r="0"+r),[i+i?" ":""+s,s?"-":"",a," ",n,":",o,":",r].join("")}function L(t){var e=E(t);0==$(".timestr").length?P(1,"operation","timestr",e):6e4<t-(a=a||Date.now())&&P(1,"operation","timestr",e);a=t}function P(t,e,i,s,a,n,o){switch("right"==i&&(n=""),e){case"text":var r=$('<div class="direct-chat-msg  direct_chat_msg '+i+" msg_"+i+'" skipTime="'+a+'">\t\t\t\t\t<div class="direct-chat-info pull-'+i+' direct-chat-info-name">'+n+'</div>\t\t\t\t\t<div class="direct-chat-text">'+s+"</div>\t\t\t\t</div>");break;case"file":r=$('<div class="direct-chat-msg  direct_chat_msg '+i+" msg_"+i+'" skipTime="'+a+'">\t\t\t\t\t\t<div class="direct-chat-info pull-'+i+' direct-chat-info-name">'+n+'</div>\t\t\t\t\t\t<div class="direct-chat-text" dataurl="'+s+'">\t\t\t\t\t\t\t<img class="msg_file" src="img/photo1.png">\t\t\t\t\t\t\t<div class="msg_file_des">\t\t\t\t\t\t\t\t<div class="file_name">问题集合.text</div>\t\t\t\t\t\t\t\t<div class="file_size">1.3M</div>\t\t\t\t\t\t\t</div>\t\t\t\t\t\t</div>\t\t\t\t\t</div>');break;case"image":r=$('<div class="direct-chat-msg  direct_chat_msg '+i+" msg_"+i+'" skipTime="'+a+'">\t\t\t\t\t\t<div class="direct-chat-info pull-'+i+' direct-chat-info-name">'+n+'</div>\t\t\t\t\t\t<div class="direct-chat-text"  >\t\t\t\t\t\t\t<img class="msg_img" src="'+x+s+'">\t\t\t\t\t\t</div>\t\t\t\t\t</div>');break;case"richtext":r=$('<div class="direct-chat-msg  direct_chat_msg '+i+" msg_"+i+'" skipTime="'+a+'">\t\t\t\t\t<div class="direct-chat-info pull-'+i+' direct-chat-info-name">'+n+'</div>\t\t\t\t\t<div class="direct-chat-text">'+s+"</div>\t\t\t\t</div>");break;case"operation":switch(i){case"timestr":r=$('<div class="direct-chat-msg timestr msg_center">\t\t\t\t\t\t\t\t\t<div>\t\t\t\t\t\t\t\t\t\t<span class="">'+s+"</span>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t</div>");break;case"center":r=$('<div class="direct-chat-msg  msg_center">\t\t\t\t\t\t\t\t\t<div>\t\t\t\t\t\t\t\t\t\t<span class="">'+s+"</span>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t</div>");break;case"access":r=$('<div class="direct-chat-msg  access_user msg_center">\t\t\t\t\t\t\t\t\t<div>\t\t\t\t\t\t\t\t\t\t<span class="">'+s+"</span>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t</div>");break;case"leaveword":r=$('<div class="direct-chat-msg  msg_center wait_prompting">\t\t\t\t\t\t\t\t\t<div>\t\t\t\t\t\t\t\t\t\t<span class="">当前排在第 <span style="color:#FD3D39">'+s+'</span> 位 ! 您可以<a class="load_message" href="javascript:void(0)">转为留言</a></span>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t</div>');break;case"leave_word":r=$('<div class="direct-chat-msg  msg_center wait_prompting">\t\t\t\t\t\t\t\t\t<div>\t\t\t\t\t\t\t\t\t\t<span class="">当前没有客服在线，</span><span class="">你也可以 <a class="load_message" href="javascript:void(0)">转为留言</a>, 客服会在第一时间联系您</span>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t</div>');break;case"closesession":r=$('<div class="direct-chat-msg  direct_chat_msg left msg_left" skipTime="'+a+'">\t\t\t\t\t\t\t\t\t<div class="direct-chat-info pull-left direct-chat-info-name">'+n+'</div>\t\t\t\t\t\t\t\t\t<div class="direct-chat-text">\t\t\t\t\t\t\t\t\t\t<div>'+s+'</div>\t\t\t\t\t\t\t\t\t\t<div class="fk_jg" style="display:none;">感谢您的反馈</div>\t\t\t\t\t\t\t\t\t\t<div class="evaluation_button_box">\t\t\t\t\t\t\t\t\t\t\t<span style="font-size: 12px;color: #888888;letter-spacing: -0.6px;">是否解决了您的问题：</span>\t\t\t\t\t\t\t\t\t\t\t<div class="score_btn" roomID="'+S()+'"  style="float:left" val="2">\t\t\t\t\t\t\t\t\t\t\t\t<img class="notScale" style="margin-left: 15px;position:relative;top:1px;" src="img/e_up.png">\t\t\t\t\t\t\t\t\t\t\t\t<span>解决</span>\t\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t\t<div class="score_btn" roomID="'+S()+'" style="float:right" val="1">\t\t\t\t\t\t\t\t\t\t\t\t<img class="notScale" style="margin-left: 10px;position:relative;top:3px;" src="img/e_down.png">\t\t\t\t\t\t\t\t\t\t\t\t<span>未解决</span>\t\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t</div>');N(),""==s&&r.find(".evaluation_button_box").css("margin-top","0px");break;case"robotclosesession":r=$('<div class="direct-chat-msg  direct_chat_msg left msg_left" skipTime="'+a+'">\t\t\t\t\t\t\t\t\t<div class="direct-chat-info pull-left direct-chat-info-name">'+n+'</div>\t\t\t\t\t\t\t\t\t<div class="direct-chat-text">\t\t\t\t\t\t\t\t\t\t<div>'+s+"</div>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t</div>");N(),""==s&&r.find(".evaluation_button_box").css("margin-top","0px");break;case"questionList":if(0==o)var c="【热点问题】";else c="您是否要咨询以下问题";r=$('<div class="direct-chat-msg  direct_chat_msg left msg_left" skipTime="'+a+'">\t\t\t\t\t\t\t\t\t\t<div class="direct-chat-info pull-left direct-chat-info-name">'+n+'</div>\t\t\t\t\t\t\t\t\t\t<div class="direct-chat-text">\t\t\t\t\t\t\t\t\t\t\t<div style="margin-bottom:10px;">'+c+"</div>\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t</div>");for(var l=0;l<s.length;l++){var m=s[l].question||s[l].StringValue,d='<div class="robot_question" message="'+m+'"  style="color:#36C0FF">'+(l+1)+". "+m+"</div>";r.find(".direct-chat-text").append(d)}if(0!=o){r.find(".direct-chat-text").append('<div style="margin-bottom:10px;">点击问题获取答案</div>')}break;case"robotscore":if(1==o)var p='<div class="ans_evaluation" >\t\t\t\t\t\t\t\t<div style="background:#36C0FF" class="evaluation_btn" roomID="'+S()+'"   val="1">\t\t\t\t\t\t\t\t\t<img class="notScale" src="img/yijiejue.png">\t\t\t\t\t\t\t\t\t<span style="color:#fff;" >已解决</span>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t<div style="border: 1px solid #DDDDDD;float:right" class="evaluation_btn" roomID="'+S()+'"  val="0">\t\t\t\t\t\t\t\t\t<img class="notScale" src="img/weijiejue.png">\t\t\t\t\t\t\t\t\t<span  style="color:#838990;">未解决</span>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>';else p="";r=$('<div style="min-width:170px;" class="direct-chat-msg  direct_chat_msg left msg_left" skipTime="'+a+'" aid="'+s.aId+'" cluid="'+s.cluid+'">\t\t\t\t\t\t\t\t\t<div class="direct-chat-info pull-left direct-chat-info-name">'+n+'</div>\t\t\t\t\t\t\t\t\t<div class="direct-chat-text">\t\t\t\t\t\t\t\t\t\t<div style="margin-bottom:0px;">'+s.content+"</div>\t\t\t\t\t\t\t\t\t\t"+p+'\t\t\t\t\t\t\t\t\t\t<div class="fk_jg" style="margin-bottom:10px;display:none;">感谢您的反馈</div>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t</div>');break;case"switchposition":r=$('<div class="direct-chat-msg  direct_chat_msg left msg_left" skipTime="'+a+'" >\t\t\t\t\t\t\t\t\t<div class="direct-chat-info pull-left direct-chat-info-name">'+n+'</div>\t\t\t\t\t\t\t\t\t<div class="direct-chat-text">\t\t\t\t\t\t\t\t\t\t<div>\t\t\t\t\t\t\t\t\t\t\t<span class="">'+s+'， 您可以<a style="color:#36C0FF;text-decoration:none" class="switchPosition" href="javascript:void(0)">转人工客服</a></span>\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t</div>');break;case"answerobj":(r=$('<div style="min-width:170px;" class="direct-chat-msg  direct_chat_msg left msg_left" skipTime="'+a+'">\t\t\t\t\t\t\t\t<div class="direct-chat-info pull-left direct-chat-info-name">易米小超人</div>\t\t\t\t\t\t\t\t<div class="direct-chat-text">\t\t\t\t\t\t\t\t\t<div style="margin-bottom:10px;">'+s.content+'</div>\t\t\t\t\t\t\t\t\t<div class="ans_evaluation" >\t\t\t\t\t\t\t\t\t\t<div style="background:#36C0FF" class="evaluation_btn" roomID="'+S()+'"   val="1">\t\t\t\t\t\t\t\t\t\t\t<img  class="notScale" src="img/yijiejue.png">\t\t\t\t\t\t\t\t\t\t\t<span style="color:#fff;" >已解决</span>\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t\t<div style="border: 1px solid #DDDDDD;float:right" class="evaluation_btn" roomID="'+S()+'"  val="0">\t\t\t\t\t\t\t\t\t\t\t<img  class="notScale" src="img/weijiejue.png">\t\t\t\t\t\t\t\t\t\t\t<span  style="color:#838990;">未解决</span>\t\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\t<div class="fk_jg" style="margin-bottom:10px;display:none;">感谢您的反馈</div>\t\t\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>')).find(".ans_evaluation").before('<div style="margin-bottom:10px;">您是否要咨询以下问题？</div>');for(l=0;l<s.answerList.length;l++){d='<div class="robot_question" message="'+s.answerList[l].question+'"  style="color:#36c0ff">'+(l+1)+". "+s.answerList[l].question+"</div>";r.find(".ans_evaluation").before(d)}}}if(1!=t)return r;$(".direct-chat-messages").append(r),$(r)[0].scrollIntoView(!0),"file"!=e&&"image"!=e||setTimeout(function(){$(r)[0].scrollIntoView(!0)},150)}function q(t){$.ajax({type:"GET",url:x+"/cs/guest/getHistoryMessage",data:{userid:t,role:"guest"},cache:!1,success:function(t){w("历史消息:",t),200==t.code&&function(t){var e=t.data.messages;w("会话数据:",e);for(var i=0;i<e.length;i++){var s=e[i].role,a=e[i].time,n=e[i].type,o=e[i].content;if("1"==s)var r="left",c=e[i].from?e[i].from.uid&&e[i].from.uid.nickName?e[i].from.uid.nickName:e[i].from.aid&&e[i].from.aid.sender_nickname?e[i].from.aid.sender_nickname:"":"系统消息";else if("0"==s)var r="right";else if("2"==s){n="operation";var r="center"}var l=(v=v||a)-a;if(6e4<l){var m=P(0,"operation","timestr",E(v));1!=_&&$(".direct-chat-messages").prepend(m)}else if(i==e.length-1&&0!=i){var m=P(0,"operation","timestr",E(v));1!=_&&$(".direct-chat-messages").prepend(m)}if("3"==s){var c=b.robotName?b.robotName:"易米小超人";if(5==e[i].answerType){if(1!=_){var d=JSON.parse(o),p=P(0,"operation","questionList",d.guideQuestions,a,c,0);0<d.guideQuestions.length&&$(".direct-chat-messages").prepend(p);var g=P(0,"text","left",d.HelloWord,a,c);$(".direct-chat-messages").prepend(g),_=1}}else{if(1==e[i].answerType)var h=P(0,"operation","robotscore",e[i],a,c,0);else if(2==e[i].answerType)var h=P(0,"operation","answerobj",e[i],a,c);else if(3==e[i].answerType)var h=P(0,"operation","questionList",JSON.parse(o),a,c);else if(4==e[i].answerType)var h=P(0,"operation","switchposition",o,a,c);else if(6==e[i].answerType)var h=P(0,"operation","robotscore",e[i],a,c,0);$(".direct-chat-messages").prepend(h)}}else{var f=P(0,n,r,H(o),a,c);$(".direct-chat-messages").prepend(f)}if("image"==n){var u=new Image;u.src=x+o,u.onload=function(){$(".access_user")[0]?$(".access_user")[0].scrollIntoView(!0):$(".wait_prompting")[0]&&$(".wait_prompting")[0].scrollIntoView(!0)}}v=a}if(11<e.length){var f=P(0,"operation","center",'<a class="getMoreMsg">查看更多</a>');$(".direct-chat-messages").prepend(f)}0<$(".direct-chat-msg").length&&$(".direct-chat-msg")[$(".direct-chat-msg").length-1].scrollIntoView(!0)}(t)}})}function O(t){1==t?(l=1,$(".ep_logo").attr("src",g.kefuIcon),$(".web_face,.upload_img").show(),$(".switchPosition,.switch_position").hide()):(l=0,$(".web_face,.upload_img").hide(),1==b.is_has_robot&&$(".switchPosition,.switch_position").show())}function H(t){var e=new RegExp("(/::\\)|/::~|/::B|/::\\||/:8-\\)|/::<|/::\\$|/::X|/::Z|/::'\\(|/::-\\||/::@|/::P|/::D|/::O|/::\\(|/::\\+|/:--b|/::Q|/::T|/:,@P|/:,@-D|/::d|/:,@o|/::g|/:\\|-\\)|/::!|/::L|/::>|/::,@|/:,@f|/::-S|/:\\?|/:,@x|/:,@@|/::8|/:,@!|/:!!!|/:xx|/:bye|/:wipe|/:dig|/:handclap|/:&-\\(|/:B-\\)|/:<@|/:@>|/::-O|/:>-\\||/:P-\\(|/::'\\||/:X-\\)|/::\\*|/:@x|/:8\\*|/:pd|/:<W>|/:beer|/:basketb|/:oo|/:coffee|/:eat|/:pig|/:rose|/:fade|/:showlove|/:heart|/:break|/:cake|/:li|/:bome|/:kn|/:footb|/:ladybug|/:shit|/:moon|/:sun|/:gift|/:hug|/:strong|/:weak|/:share|/:v|/:@\\)|/:jj|/:@@|/:bad|/:lvu|/:no|/:ok|/:love|/:<L>|/:jump|/:shake|/:<O>|/:circle|/:kotow|/:turn|/:skip|/:oY|/:#-0|/:hiphot|/:kiss|/:<&|/:&>)","g");return t.replace(/&amp;/g,"&").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(e,function(t,e){var i=p.indexOf(t)+1;return i<10&&(i="0"+i),'<img src="plugins/emoji/face/'+i+'.gif">'})}function F(t){if(n)if(window.getSelection){"0"!=c&&document.getElementById("text_div").focus(),n.collapse(!1);for(var e=n.createContextualFragment(t),i=e.lastChild;i&&"br"==i.nodeName.toLowerCase()&&i.previousSibling&&"br"==i.previousSibling.nodeName.toLowerCase();){var s=i;i=i.previousSibling,e.removeChild(s)}n.insertNode(e),i&&(n.setEndAfter(i),n.setStartAfter(i)),o.removeAllRanges(),o.addRange(n)}else"0"!=c&&document.getElementById("text_div").focus(),n.pasteHTML(t),n.collapse(!1),n.select();else $("#text_div").append(t);$(".msg_cont").removeClass("placeholder"),"0"==c&&(24<$("#text_div").height()&&$("#text_div").css("bottom","6px"),$("#text_div").scrollTop($("#text_div")[0].scrollHeight),$("#text_div").blur())}$(".msg_cont").focus(function(){-1<navigator.userAgent.indexOf("iphone")&&setTimeout(function(){window.scrollTo(0,$("body")[0].offsetHeight),$(".direct-chat-messages").scrollTop($(".direct-chat-messages").get(0).scrollHeight-$(".direct-chat-messages")[0].offsetHeight)},500),$(this).removeClass("placeholder"),h.emit("typing",{status:1,roomID:S()})}),$(".msg_cont").blur(function(){w("失去焦点"),""==$(this).html().replace("<br>","").replace(/\s+/g,"").replace(/&nbsp;+/g,"")?($(this).html(""),$(this).addClass("placeholder")):$(this).removeClass("placeholder"),h.emit("typing",{status:0,roomID:S()})}),$(".msg_cont").mouseleave(function(){var t=window.getSelection?window.getSelection():document.selection;t.focusNode&&t.focusNode.parentNode&&"text_div"===t.focusNode.parentNode.id&&(n=(o=t).createRange?o.createRange():o.getRangeAt(0))}),$(".web_face").click(function(t){if(t.stopPropagation(),"0"!=c?document.getElementById("text_div").focus():document.getElementById("text_div").blur(),0==$(this).attr("isshow")){"0"==c&&$(".session_main").css({height:"calc(100% - 257px)"});for(var e="0"==c?30:104,i=1;i<e;i++){var s=i-1;i<10&&(i="0"+i);var a=$('<li class="face pull_left" >\t\t\t\t\t\t<img dataface="'+p[s]+'" src="plugins/emoji/face/'+i+'.gif">\t\t\t\t\t</li>');$(".facelist").append(a)}$(".facelist").show(),$(this).attr("isshow","1")}else 1==$(this).attr("isshow")&&("0"==c&&$(".session_main").css({height:"100%"}),$(".facelist").hide().html(""),$(this).attr("isshow","0"))}),$("body").click(function(){"0"==c&&$(".session_main").css({height:"100%"}),$(".facelist").hide().html(""),$(".web_face").attr("isshow","0"),$(".show_box").hide()}),$(".reconnect_kefu,.wap_reconnect_kefu").click(function(){$(this).hide(),w("点击重新连接客服，原来不关闭socket的方法不妥，重新连接socket"),i=2,h.connect(),h.connected?(w("目前就处在connected!"),f(),C(1),I("notgethistory")):w("目前disconnected,等待连接结果再做后续处理")}),$("body").on("click",".load_message",function(){h.emit("user_no_wait",function(t){w(t),t&&(h.disconnect(),$(".session_main").hide(),$(".leave_word_main").show(),$(".leave_word_prompting").html("请留言，我们将在第一时间联系您"),self!=top&&D({key:"isrefresh",val:1}))})}),$("input[name='name']").bind("input propertychange",function(){k(),$("input[name='name']").next(".form_tip").remove(),$("input[name='name']").removeClass("textarea_input_red");var t=$("input[name='name']").val();$.form.isEmpty(t)?$(".name_img").show():$(".name_img").hide()}),$("input[name='name']").blur(function(){k(),setTimeout(function(){var t=$("input[name='name']").val();$(".name_img").hide(),$.form.isEmpty(t)&&0!==t.replace(/ /g,"").length?($("input[name='name']").next(".form_tip").remove(),$("input[name='name']").removeClass("textarea_input_red")):($("input[name='name']").addClass("textarea_input_red"),$("input[name='name']").next(".form_tip").remove(),$("input[name='name']").after("<span class='form_tip' >姓名不可以为空</span>"))},500)}),$("input[name='phone']").bind("input propertychange",function(){k(),$("input[name='phone']").next(".form_tip").remove(),$("input[name='phone']").removeClass("textarea_input_red"),""==$("input[name='phone']").val()?$(".phone_img").hide():$(".phone_img").show()}),$("input[name='phone']").blur(function(){k(),setTimeout(function(){$(".phone_img").hide();var t=$("input[name='phone']").val();$.form.isPhone(t)?($("input[name='phone']").next(".form_tip").remove(),$("input[name='phone']").removeClass("textarea_input_red")):($("input[name='phone']").addClass("textarea_input_red"),$("input[name='phone']").next(".form_tip").remove(),$("input[name='phone']").after("<span class='form_tip' >号码有误</span>"))},500)}),$("input[name='email']").bind("input propertychange",function(){k(),$("input[name='email']").next(".form_tip").remove(),$("input[name='email']").removeClass("textarea_input_red");var t=$("input[name='email']").val();$.form.isEmpty(t)?$(".email_img").show():$(".email_img").hide()}),$("input[name='email']").blur(function(){k(),setTimeout(function(){$(".email_img").hide();var t=$("input[name='email']").val();$.form.isEmpty(t)&&($.form.isEmail(t)?($("input[name='email']").next(".form_tip").remove(),$("input[name='email']").removeClass("textarea_input_red")):($("input[name='email']").addClass("textarea_input_red"),$("input[name='email']").next(".form_tip").remove(),$("input[name='email']").after("<span class='form_tip' >邮箱格式不正确</span>")))},500)}),$("textarea[name='message']").bind("input propertychange",function(){k(),$("textarea[name='message']").next(".form_tip").remove(),$(".post_message_main").find("textarea").removeClass("textarea_input_red"),$(".message_text_num_span").html($(this).val().length),""!=$(this).val()?$(this).next("img").show():$(this).next("img").hide(),499<$(this).val().length?($(this).val($(this).val().substring(0,500)),$(".message_text_num").css("color","#fd3d39")):$(".message_text_num").css("color","#333")}),$("textarea[name='message']").blur(function(){k(),setTimeout(function(){var t=$("textarea[name='message']").val();$(".clear_input_textarea").hide(),$.form.isEmpty(t)&&0!==t.replace(/ /g,"").length?($(".textarea_box").next(".form_tip").remove(),$(".textarea_box").removeClass("textarea_input_red")):($(".textarea_box").addClass("textarea_input_red"),$(".textarea_box").next(".form_tip").remove(),$(".textarea_box").after("<div class='form_tip' >留言内容不可以为空</div>"))},500)}),$(".name_img").click(function(){$("input[name='name']").val(""),$(this).hide()}),$(".phone_img").click(function(){$("input[name='phone']").val(""),$(this).hide()}),$(".email_img").click(function(){$("input[name='email']").val(""),$(this).hide()}),$(".clear_input_textarea").click(function(){$(this).prev("textarea").val(""),$(".message_text_num_span").html(0),$(this).hide()}),$("#send_message").click(function(){if("1"!=$("#send_message").attr("isclick")){var t=$("input[name='name']").val(),e=$("input[name='phone']").val(),i=$("input[name='email']").val(),s=$("textarea[name='message']").val(),a=M();if($(".form_tip").remove(),$(".post_message_main").find("input").removeClass("textarea_input_red"),$(".post_message_main").find("textarea").removeClass("textarea_input_red"),$.form.isEmpty(t))if($.form.isPhone(e))if($.form.isEmpty(i))if($.form.isEmail(i))if($.form.isEmpty(s)){y({name:t,mobile:e,email:i,content:s,userid:a})}else $("input[name='message']").addClass("textarea_input_red"),$("textarea[name='message']").after("<span class='form_tip'  style='position:relative;top:20px;' >留言内容不可以为空</span>");else $("input[name='email']").addClass("textarea_input_red"),$("input[name='email']").after("<span class='form_tip' >邮箱格式不正确</span>");else if($.form.isEmpty(s)&&0!==s.replace(/ /g,"").length){y({name:t,mobile:e,email:i,content:s,userid:a})}else $("input[name='message']").addClass("textarea_input_red"),$("textarea[name='message']").after("<span class='form_tip' style='position:relative;top:20px;'>留言内容不可以为空</span>");else $("input[name='phone']").addClass("textarea_input_red"),$("input[name='phone']").after("<span class='form_tip' >号码有误</span>");else $("input[name='name']").addClass("textarea_input_red"),$("input[name='name']").after("<span class='form_tip' >姓名不可以为空</span>")}}),$("body").on("click",".getMoreMsg",function(){if("没有更多消息了"!=$(".getMoreMsg").html()){var t=M();w("historyTime"+v);var e=v;w(t,e),$.ajax({type:"GET",url:x+"/cs/guest/getHistoryMessage",data:{userid:t,skipTime:e,role:"guest"},cache:!1,success:function(t){if(w("历史消息:",t),200==t.code){for(var e=t.data.messages,i=0;i<e.length;i++){var s=e[i].role,a=e[i].time,n=e[i].content,o=e[i].type,r=e[i].from?e[i].from.uid&&e[i].from.uid.nickName?e[i].from.uid.nickName:e[i].from.aid&&e[i].from.aid.sender_nickname?e[i].from.aid.sender_nickname:"":"系统消息";if("1"==s)var c="left";else if("0"==s)c="right";else if("2"==s){o="operation";c="center"}if(6e4<(v=v||a)-a)if(1==_&&5==e[i].answerType||3==s&&"这是会话结束语"==n);else{var l=P(0,"operation","timestr",E(a));$(".getMoreMsg").parents(".direct-chat-msg").after(l),$(l)[0].scrollIntoView(!0)}if("3"==s){r=b.robotName?b.robotName:"易米小超人";if(5==e[i].answerType){if(1==_)continue;var m=JSON.parse(n),d=P(0,"operation","questionList",m.guideQuestions,a,r,0);0<m.guideQuestions.length&&$(".direct-chat-messages").prepend(d);var p=P(0,"text","left",m.HelloWord,a,r);$(".direct-chat-messages").prepend(p),_=1}else{if(w(e[i]),1==e[i].answerType)var g=P(0,"operation","robotscore",e[i],a,r,0);else if(2==e[i].answerType)g=P(0,"operation","answerobj",e[i],a,r);else if(3==e[i].answerType)g=P(0,"operation","questionList",JSON.parse(n),a,r);else if(4==e[i].answerType)g=P(0,"operation","switchposition",n,a,r);else if(6==e[i].answerType)g=P(0,"operation","robotscore",e[i],a,r,0);$(".getMoreMsg").parents(".direct-chat-msg").after(g),$(g)[0]&&$(g)[0].scrollIntoView(!0)}}else{var h=P(0,o,c,H(n),a,r);$(".getMoreMsg").parents(".direct-chat-msg").after(h),$(h)[0].scrollIntoView(!0)}v=a}$(".getMoreMsg").remove();h=P(0,"operation","center",'<a class="getMoreMsg">查看更多</a>');$(".direct-chat-messages").prepend(h),(t.data.messages.length<12||0==t.data.messages.length||1==_&&1==t.data.messages.length)&&$(".getMoreMsg").html("没有更多消息了"),$(".getMoreMsg")[0].scrollIntoView(!0)}}})}else w("没有更多消息了")}),0!=c&&$(".toolbar>div").hover(function(t){$(this).find("img").attr("src",$(this).find("img").attr("movesrc"))},function(){$(this).find("img").attr("src",$(this).find("img").attr("leavesrc"))}),$("#update_img").change(function(t){if(0!=r){var e=$("#update_img").prop("files");if(e[0]){if(5242880<e[0].size)return $.tip("请发送不超过5MB的图片"),void $(this).val("");var i=e[0].name.split(".");if(!/(gif|jpg|jpeg|png|bmp)$/.test(i[i.length-1].toLowerCase()))return $.tip("图片类型必须是.gif,jpeg,jpg,png中的一种"),void $(this).val("");var s=Date.now();L(s);var a=new FileReader;a.onload=function(t){P(1,"image","right",t.target.result,s)},a.readAsDataURL(e[0]);var n=S(),o=new FormData;o.append("file",e[0]),o.append("roomID",n),$.ajax({url:x+"/cs/guest/upload",type:"POST",data:o,cache:!1,contentType:!1,processData:!1,success:function(t){if(w("文件上传",t),200==t.code){$("#update_img").val("");var e=t.path;h.emit("chat_message",{content:e,type:"image",roomID:n,time:s},function(t){w(t),h.access||(w("首次接入"),T(t,"notgethistory"))})}}})}else $(this).val("")}else $(this).val("")}),$("body").on("click",".session_win img:not('.notScale')",function(t){if(t.stopPropagation(),"face pull_left"==$(this).parent()[0].className)return F($(this).parent(".face").html()),void $(this).removeClass("placeholder");var e=$(this).attr("src");return-1==e.indexOf("emoji/face")?"0"==c?($("#img_show").attr("src",e),void $(".img_plane").show()):void(self!=top?D({key:"miHuaImgSrc",val:e}):($(".show_box").show(),$(".show_img").css("background-image","url("+e+")"))):void 0}),"0"==c&&$(".facelist").on("click","img",function(t){if(t.stopPropagation(),"face pull_left"==$(this).parent()[0].className)return F($(this).parent(".face").html()),void $(this).removeClass("placeholder")}),$(".plane_close").click(function(){$(".img_plane").hide()}),$(".img_plane").click(function(t){$(this).hide()}),$(".show_img_close").click(function(){$(".show_box").hide()}),$(".show_box").click(function(t){t.stopPropagation()}),window.onresize=function(){var t=$("html").width();2==g.advertisement&&"0"!=c?($(".session_main_right").show(),t<800?($(".announcement_con").css("height","calc(100% - "+m+"px)"),$(".session_main").css("width","540px")):800<t&&t<1075?($(".announcement_con").css("height","calc(100% - "+d+"px)"),$(".session_main").css("width","840px")):1075<t&&($(".announcement_con").css("height","calc(100% - "+d+"px)"),$(".session_main").css("width","1075px"))):1==g.advertisement&&"0"!=c&&($(".session_main_right").hide(),t<800?$(".session_main").css("width","360px"):800<t&&t<1075?$(".session_main").css("width","590px"):1075<t&&$(".session_main").css("width","825px"))};var A="hidden"in document?"hidden":"webkitHidden"in document?"webkitHidden":"mozHidden"in document?"mozHidden":null,R=A.replace(/hidden/i,"visibilitychange"),B=function(t){document[A]?D({key:"startroasting",val:t}):D({key:"endroasting"})};document.addEventListener(R,function(t){document[A]||B()})});